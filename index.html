‚Ä®‚Ä®<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLASSIFIED - Hoi An Social Discovery</title>
    <link rel="stylesheet" href="css/main.css">    
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB-zTm6JB4EkD_7Q9056K4UGbIPyHQL4S4",
            authDomain: "hoi-an-social-app.firebaseapp.com",
            databaseURL: "https://hoi-an-social-app-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "hoi-an-social-app",
            storageBucket: "hoi-an-social-app.firebasestorage.app",
            messagingSenderId: "302219568692",
            appId: "1:302219568692:web:3edf7128342b74b1e0cc61",
            measurementId: "G-WX23VDV53B"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        
        // Initialize services
        window.auth = firebase.auth();
        window.db = firebase.firestore();
        window.storage = firebase.storage();
        
        // Mark Firebase as ready
        window.CLASSIFIED = window.CLASSIFIED || {};
        window.CLASSIFIED.state = window.CLASSIFIED.state || {};
        window.CLASSIFIED.state.firebaseReady = true;
        
        console.log('üî• Firebase initialized successfully!');
    </script>

</head>
<body>
    <div class="app-container">
        <!-- Guest Mode Banner -->
        <div id="guestBanner" class="guest-banner" style="display: none;" onclick="CLASSIFIED.showLogin()">
            üöÄ Join CLASSIFIED to connect with travelers and discover hidden gems! Tap to sign up
        </div>
        
        <!-- Main Screens Container -->
        <div class="main-screens">
            <!-- Restaurant Feed Screen -->
            <div id="restaurantScreen" class="screen active">
                <div class="header">
                    <button class="back-btn">‚Üê</button>
                    <div class="header-title">Hungry?</div>
                    <button class="settings-btn" onclick="CLASSIFIED.openSettings()">‚öôÔ∏è</button>
                </div>
                <div class="search-bar">
                    <input type="text" class="search-input" placeholder="Find Restaurant...">
                    <button class="filter-btn">üîΩ Filter by preferences</button>
                </div>
                <div class="stories-section">
                    <div class="stories-title">DAILY STORIES</div>
                    <div class="stories-scroll" id="restaurantStories">
                        <!-- Stories populated by JavaScript -->
                    </div>
                </div>
                <div class="feed-container">
                    <div class="feed-header">
                        <h3>FEATURED</h3>
                    </div>
                    <div id="restaurantFeed">
                        <!-- Restaurant cards populated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- Social Screen -->
            <div id="socialScreen" class="screen">
                <div class="header">
                    <button class="back-btn">‚Üê</button>
                    <div class="header-title">Feeling Adventurous?!</div>
                    <div class="match-badge">83% Match</div>
                </div>
                <div class="social-tabs">
                    <div class="social-tab active" data-tab="userFeed">üë• Browse People</div>
                    <div class="social-tab" data-tab="messaging">üí¨ Messaging</div>
                </div>
                
                <!-- User Feed Content -->
                <div id="userFeedContent" class="social-content active">
                    <div class="filter-options">
                        <div class="filter-chip active" data-filter="all">All</div>
                        <div class="filter-chip" data-filter="online">üü¢ Online Now</div>
                        <div class="filter-chip" data-filter="nearby">üìç Nearby</div>
                        <div class="filter-chip" data-filter="nomads">üíª Digital Nomads</div>
                    </div>
                    <div class="user-feed-container" id="userFeedContainer">
                        <!-- User feed items populated by JavaScript -->
                    </div>
                </div>
                
                <!-- Messaging Content -->
                <div id="messagingContent" class="social-content">
                    <div class="messaging-container">
                        <div class="matches-section">
                            <div class="matches-title">New Matches</div>
                            <div class="matches-scroll" id="matchesScroll">
                                <!-- Match avatars populated by JavaScript -->
                            </div>
                        </div>
                        <div class="chat-list" id="chatList">
                            <!-- Chat items populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Activity Feed Screen -->
            <div id="activityScreen" class="screen">
                <div class="header">
                    <button class="back-btn">‚Üê</button>
                    <div class="header-title">Feeling Adventurous?!</div>
                    <button class="settings-btn" onclick="CLASSIFIED.openSettings()">‚öôÔ∏è</button>
                </div>
                <div class="search-bar">
                    <input type="text" class="search-input" placeholder="Find Activity...">
                    <button class="filter-btn">üîΩ Filter by preferences</button>
                </div>
                <div class="stories-section">
                    <div class="stories-title">DAILY STORIES</div>
                    <div class="stories-scroll" id="activityStories">
                        <!-- Stories populated by JavaScript -->
                    </div>
                </div>
                <div class="feed-container">
                    <div class="feed-header">
                        <h3>FEATURED</h3>
                    </div>
                    <div id="activityFeed">
                        <!-- Activity cards populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Profile Editor Overlay -->
        <div id="profileEditor" class="overlay-screen">
            <div class="header">
                <button class="back-btn" onclick="CLASSIFIED.closeProfileEditor()">‚Üê</button>
                <div class="header-title">Edit Profile</div>
                <button class="settings-btn" onclick="CLASSIFIED.viewMyProfile()">üë§</button>
            </div>
            <div class="profile-editor">
                <!-- Profile Photos Section -->
                <div class="profile-section">
                    <div class="section-title">Profile Photos</div>
                    <div class="photo-upload-section" onclick="CLASSIFIED.triggerPhotoUpload()">
                        <div style="font-size: 48px; margin-bottom: 10px; opacity: 0.5;">üì∑</div>
                        <div style="font-weight: 600;">Add Your Best Photos</div>
                        <div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">Tap to add photos</div>
                    </div>
                    <div class="photo-grid" id="photoGrid">
                        <div class="photo-slot" onclick="CLASSIFIED.triggerPhotoUpload(0)">
                            <span style="font-size: 24px; opacity: 0.5;">+</span>
                        </div>
                        <div class="photo-slot" onclick="CLASSIFIED.triggerPhotoUpload(1)">
                            <span style="font-size: 24px; opacity: 0.5;">+</span>
                        </div>
                        <div class="photo-slot" onclick="CLASSIFIED.triggerPhotoUpload(2)">
                            <span style="font-size: 24px; opacity: 0.5;">+</span>
                        </div>
                        <div class="photo-slot" onclick="CLASSIFIED.triggerPhotoUpload(3)">
                            <span style="font-size: 24px; opacity: 0.5;">+</span>
                        </div>
                    </div>
                </div>
                
                <!-- About Me Section -->
                <div class="profile-section">
                    <div class="section-title">About Me</div>
                    <div class="form-group">
                        <label class="form-label">Bio</label>
                        <textarea class="form-input form-textarea" id="profileBio" placeholder="Write about yourself or something you're up to..."></textarea>
                    </div>
                </div>
                
                <!-- Basic Info Section -->
                <div class="profile-section">
                    <div class="section-title">Basic Info</div>
                    
                    <div class="form-group">
                        <label class="form-label">Birthday</label>
                        <input type="date" class="form-input" id="profileBirthday">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Zodiac Sign</label>
                        <div class="choice-group">
                            <div class="choice-btn" data-choice="zodiac" data-value="Aries">‚ôà Aries</div>
                            <div class="choice-btn" data-choice="zodiac" data-value="Taurus">‚ôâ Taurus</div>
                            <div class="choice-btn" data-choice="zodiac" data-value="Gemini">‚ôä Gemini</div>
                            <div class="choice-btn" data-choice="zodiac" data-value="Cancer">‚ôã Cancer</div>
                            <div class="choice-btn" data-choice="zodiac" data-value="Leo">‚ôå Leo</div>
                            <div class="choice-btn" data-choice="zodiac" data-value="Virgo">‚ôç Virgo</div>
                            <div class="choice-btn" data-choice="zodiac" data-value="Libra">‚ôé Libra</div>
                            <div class="choice-btn" data-choice="zodiac" data-value="Scorpio">‚ôè Scorpio</div>
                            <div class="choice-btn" data-choice="zodiac" data-value="Sagittarius">‚ôê Sagittarius</div>
                            <div class="choice-btn" data-choice="zodiac" data-value="Capricorn">‚ôë Capricorn</div>
                            <div class="choice-btn" data-choice="zodiac" data-value="Aquarius">‚ôí Aquarius</div>
                            <div class="choice-btn" data-choice="zodiac" data-value="Pisces">‚ôì Pisces</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Height</label>
                        <input type="text" class="form-input" id="profileHeight" placeholder="5'7&quot; or 170cm">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Career</label>
                        <div class="choice-group">
                            <div class="choice-btn" data-choice="career" data-value="Student">Student</div>
                            <div class="choice-btn" data-choice="career" data-value="Digital Nomad">Digital Nomad</div>
                            <div class="choice-btn" data-choice="career" data-value="Teacher">Teacher</div>
                            <div class="choice-btn" data-choice="career" data-value="Nurse">Nurse</div>
                            <div class="choice-btn" data-choice="career" data-value="Engineer">Engineer</div>
                            <div class="choice-btn" data-choice="career" data-value="Artist">Artist</div>
                            <div class="choice-btn" data-choice="career" data-value="Business">Business</div>
                            <div class="choice-btn" data-choice="career" data-value="Other">Other</div>
                        </div>
                    </div>
                </div>
                
                <!-- Interests Section -->
                <div class="profile-section">
                    <div class="section-title">What Am I Like</div>
                    <div class="interests-grid">
                        <div class="interest-btn" data-interest="Adventure">Adventure</div>
                        <div class="interest-btn" data-interest="Reading">Reading</div>
                        <div class="interest-btn" data-interest="Sports">Sports</div>
                        <div class="interest-btn" data-interest="Music">Music</div>
                        <div class="interest-btn" data-interest="Travel">Travel</div>
                        <div class="interest-btn" data-interest="Food">Food</div>
                        <div class="interest-btn" data-interest="Art">Art</div>
                        <div class="interest-btn" data-interest="Fitness">Fitness</div>
                        <div class="interest-btn" data-interest="Photography">Photography</div>
                        <div class="interest-btn" data-interest="Cooking">Cooking</div>
                        <div class="interest-btn" data-interest="Dancing">Dancing</div>
                        <div class="interest-btn" data-interest="Gaming">Gaming</div>
                    </div>
                </div>
                
                <!-- Preferences Section -->
                <div class="profile-section">
                    <div class="section-title">What Do I Like Most</div>
                    <div class="choice-group">
                        <div class="choice-btn" data-choice="priority" data-value="Travel">Travel</div>
                        <div class="choice-btn" data-choice="priority" data-value="Friends">Friends</div>
                        <div class="choice-btn" data-choice="priority" data-value="Family">Family</div>
                        <div class="choice-btn" data-choice="priority" data-value="Career">Career</div>
                    </div>
                </div>
                
                <!-- Relationship Section -->
                <div class="profile-section">
                    <div class="section-title">Relationship Status</div>
                    <div class="choice-group">
                        <div class="choice-btn" data-choice="relationship" data-value="Single">Single</div>
                        <div class="choice-btn" data-choice="relationship" data-value="In a Relationship">In a Relationship</div>
                        <div class="choice-btn" data-choice="relationship" data-value="Common Law w. Children">Common Law w. Children</div>
                        <div class="choice-btn" data-choice="relationship" data-value="It's Complicated">It's Complicated</div>
                    </div>
                </div>
                
                <!-- Looking For Section -->
                <div class="profile-section">
                    <div class="section-title">What Am I Looking For</div>
                    <div class="choice-group">
                        <div class="choice-btn" data-choice="lookingFor" data-value="Friends">Friends</div>
                        <div class="choice-btn" data-choice="lookingFor" data-value="Dating">Dating</div>
                        <div class="choice-btn" data-choice="lookingFor" data-value="Networking">Networking</div>
                        <div class="choice-btn" data-choice="lookingFor" data-value="Adventure Buddies">Adventure Buddies</div>
                    </div>
                </div>
                
                <!-- Marriage Thoughts Section -->
                <div class="profile-section">
                    <div class="section-title">Thoughts about Marriage</div>
                    <div class="choice-group">
                        <div class="choice-btn" data-choice="marriage" data-value="Wants One Day">üíç Wants One Day</div>
                        <div class="choice-btn" data-choice="marriage" data-value="Not Sure">ü§∑ Not Sure</div>
                        <div class="choice-btn" data-choice="marriage" data-value="Not Interested">‚ùå Not Interested</div>
                    </div>
                </div>
                
                <button class="save-profile-btn" onclick="CLASSIFIED.saveUserProfile()">Save Profile</button>
            </div>
        </div>
        
        <!-- Business Profile Editor Overlay -->
        <div id="businessProfileEditor" class="overlay-screen">
            <div class="header">
                <button class="back-btn" onclick="CLASSIFIED.closeBusinessProfileEditor()">‚Üê</button>
                <div class="header-title">Business Profile</div>
                <button class="settings-btn" onclick="CLASSIFIED.viewBusinessProfile()">üè™</button>
            </div>
            <div class="profile-editor">
                <!-- Business Photos Section -->
                <div class="profile-section">
                    <div class="section-title">Business Photos</div>
                    <div class="photo-upload-section" onclick="CLASSIFIED.triggerBusinessPhotoUpload()">
                        <div style="font-size: 48px; margin-bottom: 10px; opacity: 0.5;">üì∑</div>
                        <div style="font-weight: 600;">Add Business Photos</div>
                        <div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">Main photo, interior, products, etc.</div>
                    </div>
                    <div class="photo-grid" id="businessPhotoGrid">
                        <div class="photo-slot" onclick="CLASSIFIED.triggerBusinessPhotoUpload(0)">
                            <span style="font-size: 24px; opacity: 0.5;">+</span>
                        </div>
                        <div class="photo-slot" onclick="CLASSIFIED.triggerBusinessPhotoUpload(1)">
                            <span style="font-size: 24px; opacity: 0.5;">+</span>
                        </div>
                        <div class="photo-slot" onclick="CLASSIFIED.triggerBusinessPhotoUpload(2)">
                            <span style="font-size: 24px; opacity: 0.5;">+</span>
                        </div>
                        <div class="photo-slot" onclick="CLASSIFIED.triggerBusinessPhotoUpload(3)">
                            <span style="font-size: 24px; opacity: 0.5;">+</span>
                        </div>
                    </div>
                </div>
                
                <!-- Business Information Section -->
                <div class="profile-section">
                    <div class="section-title">Business Information</div>
                    <div class="form-group">
                        <label class="form-label">Business Name</label>
                        <input type="text" class="form-input" id="businessName" placeholder="Your Business Name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Business Type</label>
                        <select class="form-select" id="businessType">
                            <option value="">Select Type</option>
                            <option value="restaurant">Restaurant/Bar</option>
                            <option value="activity">Activity/Tour</option>
                            <option value="accommodation">Hotel/Hostel</option>
                            <option value="retail">Shop/Retail</option>
                            <option value="service">Service</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-input form-textarea" id="businessDescription" placeholder="Tell travelers about your business..."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <input type="text" class="form-input" id="businessAddress" placeholder="123 Street Name, Hoi An">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone Number</label>
                        <input type="tel" class="form-input" id="businessPhone" placeholder="+84 123 456 789">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Opening Hours</label>
                        <input type="text" class="form-input" id="businessHours" placeholder="8:00 AM - 10:00 PM">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Price Range</label>
                        <select class="form-select" id="businessPriceRange">
                            <option value="budget">$ - Budget Friendly</option>
                            <option value="moderate">$$ - Moderate</option>
                            <option value="expensive">$$$ - Expensive</option>
                        </select>
                    </div>
                </div>
                
                <!-- Current Promotion Section -->
                <div class="profile-section">
                    <div class="section-title">Current Promotion</div>
                    <div class="form-group">
                        <label class="form-label">Promotion Title</label>
                        <input type="text" class="form-input" id="businessPromoTitle" placeholder="Happy Hour Special">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Promotion Details</label>
                        <textarea class="form-input form-textarea" id="businessPromoDetails" placeholder="50% off all drinks 5-7pm daily"></textarea>
                    </div>
                </div>
                
                <button class="save-profile-btn" onclick="CLASSIFIED.saveBusinessProfile()">Save Business Profile</button>
            </div>
        </div>
        
        <!-- User Profile View Overlay -->
        <div id="userProfileView" class="overlay-screen">
            <div class="header">
                <button class="back-btn" onclick="CLASSIFIED.closeUserProfile()">‚Üê</button>
                <div class="header-title" id="userProfileTitle">Profile</div>
                <button class="settings-btn" onclick="CLASSIFIED.startChatWithViewedUser()">üí¨</button>
            </div>
            <div class="profile-hero" id="userProfileHero">
                <div class="profile-overlay">
                    <div class="profile-name" id="userProfileName">Loading...</div>
                    <div class="profile-type" id="userProfileAge">Loading...</div>
                    <div class="profile-rating">
                        <div class="stars" style="color: #00D4FF;">üî•üî•üî•</div>
                        <span id="userProfileMatch">85% Match</span>
                    </div>
                </div>
            </div>
            <div class="profile-content">
                <div class="profile-section">
                    <div class="section-title">About</div>
                    <div class="profile-description" id="userProfileBio">
                        Loading user bio...
                    </div>
                </div>
                <div class="profile-section">
                    <div class="section-title">Details</div>
                    <div class="profile-details">
                        <div class="detail-item">
                            <div class="detail-label">üìç Distance</div>
                            <div class="detail-value" id="userProfileDistance">-</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">üü¢ Status</div>
                            <div class="detail-value" id="userProfileStatus">-</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">üìä Category</div>
                            <div class="detail-value" id="userProfileCategory">-</div>
                        </div>
                    </div>
                </div>
                <div class="profile-section">
                    <div class="section-title">Interests</div>
                    <div class="user-interests" id="userProfileInterests">
                        <!-- Interests populated by JavaScript -->
                    </div>
                </div>
            </div>
            <div class="action-buttons">
                <button class="action-button secondary-btn" onclick="CLASSIFIED.handleUserAction('pass')">‚úï Pass</button>
                <button class="action-button primary-btn" onclick="CLASSIFIED.handleUserAction('like')">üí¨ Like</button>
            </div>
        </div>
        
        <!-- My Profile View Overlay -->
        <div id="myProfileView" class="overlay-screen">
            <div class="header">
                <button class="back-btn" onclick="CLASSIFIED.closeMyProfile()">‚Üê</button>
                <div class="header-title">My Profile</div>
                <button class="settings-btn" onclick="CLASSIFIED.openProfileEditor()">‚úèÔ∏è</button>
            </div>
            <div class="profile-hero" id="myProfileHero" style="background-image: url('https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400&h=300&fit=crop')">
                <div class="profile-overlay">
                    <div class="profile-name" id="myProfileName">Your Name</div>
                    <div class="profile-type" id="myProfileAge">Age</div>
                </div>
            </div>
            <div class="profile-content">
                <div class="profile-section">
                    <div class="section-title">About Me</div>
                    <div class="profile-description" id="myProfileBio">
                        Complete your profile to start connecting with amazing people in Hoi An!
                    </div>
                </div>
                <div class="profile-section">
                    <div class="section-title">Details</div>
                    <div class="profile-details">
                        <div class="detail-item">
                            <div class="detail-label">üéÇ Age</div>
                            <div class="detail-value" id="myProfileAgeDetail">-</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">üìè Height</div>
                            <div class="detail-value" id="myProfileHeightDetail">-</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">üíº Career</div>
                            <div class="detail-value" id="myProfileCareerDetail">-</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">‚≠ê Zodiac</div>
                            <div class="detail-value" id="myProfileZodiacDetail">-</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">üíù Looking For</div>
                            <div class="detail-value" id="myProfileLookingForDetail">-</div>
                        </div>
                    </div>
                </div>
                <div class="profile-section">
                    <div class="section-title">My Interests</div>
                    <div class="user-interests" id="myProfileInterests">
                        <!-- Interests populated by JavaScript -->
                    </div>
                </div>
            </div>
            <div class="action-buttons">
                <button class="action-button secondary-btn" onclick="CLASSIFIED.shareMyProfile()">Share Profile</button>
                <button class="action-button primary-btn" onclick="CLASSIFIED.openProfileEditor()">Edit Profile</button>
            </div>
        </div>
        
        <!-- Business Profile View Overlay -->
        <div id="businessProfile" class="overlay-screen">
            <div class="header">
                <button class="back-btn" id="profileBackBtn">‚Üê</button>
                <div class="header-title" id="profileHeaderTitle">Business Profile</div>
                <button class="settings-btn">‚öôÔ∏è</button>
            </div>
            <div class="profile-hero" id="profileHero">
                <div class="profile-overlay">
                    <div class="profile-name" id="profileName">Loading...</div>
                    <div class="profile-type" id="profileType">Loading...</div>
                    <div class="profile-rating">
                        <div class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
                        <span>4.8 (124 reviews)</span>
                    </div>
                </div>
            </div>
            <div class="profile-content">
                <div class="profile-section">
                    <div class="current-promo">
                        <div class="promo-badge">üî• SPECIAL OFFER</div>
                        <div class="promo-title" id="profilePromoTitle">Loading...</div>
                        <div class="promo-details" id="profilePromoDetails">Loading...</div>
                    </div>
                </div>
                <div class="profile-section">
                    <div class="section-title">About</div>
                    <div class="profile-description" id="profileDescription">
                        A vibrant spot in the heart of Hoi An, perfect for backpackers and travelers.
                    </div>
                </div>
                <div class="profile-section">
                    <div class="section-title">Details</div>
                    <div class="profile-details">
                        <div class="detail-item">
                            <div class="detail-label">üìç Location</div>
                            <div class="detail-value" id="profileLocation">Hoi An Ancient Town</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">üïí Hours</div>
                            <div class="detail-value" id="profileHours">5:00 PM - 2:00 AM</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">üí∞ Price Range</div>
                            <div class="detail-value" id="profilePrice">$ - Moderate</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">üì± Contact</div>
                            <div class="detail-value" id="profileContact">+84 123 456 789</div>
                        </div>
                    </div>
                </div>
                <div class="profile-section">
                    <div class="section-title">Popular With</div>
                    <div class="user-interests">
                        <span class="interest-tag">Backpackers</span>
                        <span class="interest-tag">Digital Nomads</span>
                        <span class="interest-tag">Expats</span>
                        <span class="interest-tag">Live Music Lovers</span>
                    </div>
                </div>
            </div>
            <div class="action-buttons">
                <button class="action-button secondary-btn" onclick="CLASSIFIED.shareBusinessProfile()">Share</button>
                <button class="action-button primary-btn" onclick="CLASSIFIED.getDirections()">Get Directions</button>
            </div>
        </div>
        
        <!-- Individual Chat Overlay -->
        <div id="individualChat" class="overlay-screen">
            <div class="chat-header">
                <button class="back-btn" id="chatBackBtn">‚Üê</button>
                <div class="chat-header-avatar" id="chatAvatar" onclick="CLASSIFIED.openProfileFromChat();"></div>
                <div class="chat-header-info" onclick="CLASSIFIED.openProfileFromChat();">
                    <div class="chat-header-name" id="chatName">Jessica</div>
                    <div class="chat-status">Online now</div>
                </div>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="message received">
                    <div class="message-bubble">Hey! I saw you're into live music too üéµ</div>
                </div>
                <div class="message sent">
                    <div class="message-bubble">Yes! Love finding new venues. Any recommendations in Hoi An?</div>
                </div>
                <div class="message received">
                    <div class="message-bubble">Actually, I just got this promo for tonight!</div>
                </div>
                <div class="message received">
                    <div class="promo-message-card">
                        <div class="promo-title">üç∑ Date Night Special</div>
                        <div class="promo-details">2-for-1 Cocktails + Free Appetizer<br>Tonight 6-9pm<br>Banh Mi Queen</div>
                    </div>
                </div>
                <div class="message sent">
                    <div class="message-bubble">Perfect! Want to check it out together? üòä</div>
                </div>
            </div>
            <div class="chat-input">
                <input type="text" placeholder="Type a message..." id="messageInput">
                <button class="send-btn" id="sendBtn">‚û§</button>
            </div>
        </div>
        
        <!-- Match Popup -->
        <div id="matchPopup" class="match-popup">
            <div class="match-content">
                <div class="match-text">IT'S A MATCH! üéâ</div>
                <p>You and Jessica both liked each other</p>
                <button class="match-btn" id="startChatBtn">Start Chatting</button>
            </div>
        </div>
        
        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="loading-overlay">
            <div class="spinner"></div>
        </div>
        
        <!-- Login Screen -->
        <div id="loginScreen" class="auth-screen">
            <div class="auth-header">
                <div class="auth-logo">CLASSIFIED</div>
                <div class="auth-tagline">Discover Hoi An's Hidden Gems</div>
            </div>
            <div class="auth-form">
                <input type="email" class="auth-input" id="loginEmail" placeholder="Email address">
                <input type="password" class="auth-input" id="loginPassword" placeholder="Password">
                <button class="auth-btn" onclick="CLASSIFIED.loginWithEmail()">Sign In</button>
                
                <div class="auth-divider">
                    <span>or</span>
                </div>
                
                <button class="auth-btn google-btn" onclick="CLASSIFIED.loginWithGoogle()">
                    <span>üåü</span>
                    Continue with Google
                </button>
            </div>
            <div class="auth-switch">
                Don't have an account? <a href="#" onclick="CLASSIFIED.showRegister()">Sign up</a> | 
                <a href="#" onclick="CLASSIFIED.showBusinessAuth()">Business Login</a> | 
                <a href="#" onclick="CLASSIFIED.enableGuestMode()">Browse as Guest</a>
            </div>
        </div>
        
        <!-- Registration Screen -->
        <div id="registerScreen" class="auth-screen">
            <div class="auth-header">
                <div class="auth-logo">CLASSIFIED</div>
                <div class="auth-tagline">Join the Hoi An Community</div>
            </div>
            <div class="auth-form">
                <input type="text" class="auth-input" id="registerName" placeholder="Your name">
                <input type="email" class="auth-input" id="registerEmail" placeholder="Email address">
                <input type="password" class="auth-input" id="registerPassword" placeholder="Create password">
                <input type="password" class="auth-input" id="registerConfirmPassword" placeholder="Confirm password">
                <button class="auth-btn" onclick="CLASSIFIED.registerWithEmail()">Create Account</button>
                
                <div class="auth-divider">
                    <span>or</span>
                </div>
                
                <button class="auth-btn google-btn" onclick="CLASSIFIED.loginWithGoogle()">
                    <span>üåü</span>
                    Continue with Google
                </button>
            </div>
            <div class="auth-switch">
                Already have an account? <a href="#" onclick="CLASSIFIED.showLogin()">Sign in</a> | 
                <a href="#" onclick="CLASSIFIED.showBusinessAuth()">Business Login</a>
            </div>
        </div>
        
        <!-- Business Auth Screen -->
        <div id="businessAuthScreen" class="auth-screen">
            <div class="auth-header">
                <div class="auth-logo">CLASSIFIED</div>
                <div class="auth-tagline">Business Portal</div>
            </div>
            
            <div class="business-auth-tabs">
                <div class="business-auth-tab active" onclick="CLASSIFIED.switchBusinessAuthTab('login')">Login</div>
                <div class="business-auth-tab" onclick="CLASSIFIED.switchBusinessAuthTab('signup')">Create Account</div>
            </div>
            
            <!-- Business Login Form -->
            <div id="businessLoginForm" class="business-auth-form active">
                <input type="email" class="auth-input" id="businessLoginEmail" placeholder="Business email">
                <input type="password" class="auth-input" id="businessLoginPassword" placeholder="Password">
                <button class="auth-btn" onclick="CLASSIFIED.businessLogin()">Login to Dashboard</button>
                <p style="text-align: center; font-size: 12px; opacity: 0.7; margin-top: 10px;">
                    Forgot your password? Contact support@classified.com
                </p>
            </div>
            
            <!-- Business Signup Form -->
            <div id="businessSignupForm" class="business-auth-form">
                <p style="text-align: center; font-size: 14px; opacity: 0.8; margin-bottom: 20px;">
                    Create your business account instantly!
                </p>
                <input type="text" class="auth-input" id="businessSignupName" placeholder="Business Name">
                <input type="email" class="auth-input" id="businessSignupEmail" placeholder="Business Email">
                <input type="tel" class="auth-input" id="businessSignupPhone" placeholder="WhatsApp Number">
                <select class="auth-input" id="businessSignupType">
                    <option value="">Select Business Type</option>
                    <option value="restaurant">Restaurant/Bar</option>
                    <option value="activity">Activity/Tour</option>
                    <option value="accommodation">Hotel/Hostel</option>
                    <option value="retail">Shop/Retail</option>
                    <option value="service">Service</option>
                </select>
                <div style="background: rgba(0,212,255,0.1); border-radius: 10px; padding: 12px; margin-bottom: 15px; font-size: 12px; opacity: 0.9;">
                    ‚úÖ Instant account creation<br>
                    ‚úÖ Complete your profile right away<br>
                    ‚úÖ Get approved within 24 hours
                </div>
                <button class="auth-btn" onclick="CLASSIFIED.businessSignup()">Create Business Account</button>
            </div>
            
            <div class="auth-switch">
                <a href="#" onclick="CLASSIFIED.showLogin()">‚Üê Back to User Login</a>
            </div>
        </div>
        
        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="nav-item active" data-screen="restaurant">
                <div class="nav-icon">üèÉ</div>
                <div class="nav-label">Your Event</div>
            </div>
            <div class="nav-item" data-screen="social">
                <div class="nav-icon">üéÄ</div>
                <div class="nav-label">Your Social</div>
            </div>
            <div class="nav-item" data-screen="activity">
                <div class="nav-icon">üì¶</div>
                <div class="nav-label">Your Activity</div>
            </div>
        </div>
        
        <!-- Hidden file input for photo uploads -->
        <input type="file" id="photoUpload" accept="image/*" style="display: none;" onchange="CLASSIFIED.handlePhotoUpload(event)">
        <input type="file" id="businessPhotoUpload" accept="image/*" style="display: none;" onchange="CLASSIFIED.handleBusinessPhotoUpload(event)">
    </div>
    
    <script>
        // üéØ CLASSIFIED v7.0 - Complete Business Management System
        // 
        // BUSINESS WORKFLOW:
        // 1. Business signs up ‚Üí gets instant account with temp password
        // 2. Business logs in ‚Üí completes profile ‚Üí status: pending_approval
        // 3. Admin reviews ‚Üí approves ‚Üí status: active ‚Üí appears in feeds
        // 4. Business can manage their profile and view dashboard
        //
        // ADMIN WORKFLOW:
        // 1. Set your admin email in isAdminUser() function
        // 2. Admin sees "Admin Panel" in settings
        // 3. Admin can approve/reject businesses
        // 4. Admin gets notifications of pending businesses
        //
        // USER WORKFLOW:
        // 1. Can browse as guest (limited)
        // 2. Sign up for full access
        // 3. Complete profile ‚Üí appears in user feed
        // 4. Referral system for growth
        
        const CLASSIFIED = {
            // Enhanced App State Management
            state: {
                currentScreen: 'restaurant',
                currentSocialTab: 'userFeed',
                currentBusiness: null,
                currentViewedUser: null,
                currentChatUser: null,
                currentUser: null,
                isAuthenticated: false,
                isGuestMode: false,
                isProfileOpen: false,
                isChatOpen: false,
                isProfileEditorOpen: false,
                isUserProfileOpen: false,
                isBusinessProfileEditorOpen: false,
                currentUploadSlot: null,
                currentBusinessUploadSlot: null,
                userProfile: {
                    name: '',
                    age: '',
                    bio: '',
                    birthday: '',
                    zodiac: '',
                    height: '',
                    career: '',
                    interests: [],
                    priority: '',
                    relationship: '',
                    lookingFor: '',
                    marriage: '',
                    photos: [],
                    referralCode: ''
                },
                businessProfile: {
                    name: '',
                    type: '',
                    description: '',
                    address: '',
                    phone: '',
                    hours: '',
                    priceRange: '',
                    promoTitle: '',
                    promoDetails: '',
                    photos: []
                }
            },
            
            // Enhanced App Data
            data: {
                users: [
                    {
                        name: "Jessica",
                        age: 28,
                        image: "https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=400&h=600&fit=crop",
                        interests: ["Reading", "Gym", "Music", "Laughter", "Cafe Connoisseur"],
                        bio: "Backpacker exploring Vietnam üáªüá≥ Looking for adventure buddies and great coffee spots!",
                        isOnline: true,
                        distance: "2 km",
                        matchPercentage: 83,
                        category: "nomads"
                    },
                    {
                        name: "Dave",
                        age: 32,
                        image: "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400&h=600&fit=crop",
                        interests: ["Surfing", "Photography", "Coffee", "Adventure Sports", "Live Music"],
                        bio: "Digital nomad loving Hoi An vibes ‚ú® Always down for beach days and exploring local culture.",
                        isOnline: false,
                        distance: "1.5 km",
                        matchPercentage: 76,
                        category: "nomads"
                    },
                    {
                        name: "Rebecca",
                        age: 26,
                        image: "https://images.unsplash.com/photo-1508214751196-bcfd4ca60f91?w=400&h=600&fit=crop",
                        interests: ["Yoga", "Cooking", "Beach", "Art", "Nightlife"],
                        bio: "Artist seeking creative adventures üé® Love painting landscapes and meeting fellow creatives!",
                        isOnline: true,
                        distance: "800m",
                        matchPercentage: 91,
                        category: "all"
                    },
                    {
                        name: "Alex",
                        age: 29,
                        image: "https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=400&h=600&fit=crop",
                        interests: ["Hiking", "Beer", "Football", "Travel", "Food"],
                        bio: "Exploring Southeast Asia one city at a time üåè Football fanatic and craft beer enthusiast.",
                        isOnline: true,
                        distance: "3.2 km",
                        matchPercentage: 68,
                        category: "all"
                    },
                    {
                        name: "Maria",
                        age: 24,
                        image: "https://images.unsplash.com/photo-1534528741775-53994a69daeb?w=400&h=600&fit=crop",
                        interests: ["Dancing", "Food", "Travel", "Photography", "Beach"],
                        bio: "Spanish girl making memories in Vietnam üíÉ Love salsa dancing and trying street food!",
                        isOnline: false,
                        distance: "4.1 km",
                        matchPercentage: 79,
                        category: "all"
                    },
                    {
                        name: "James",
                        age: 30,
                        image: "https://images.unsplash.com/photo-1492562080023-ab3db95bfbce?w=400&h=600&fit=crop",
                        interests: ["Music", "Art", "Coffee", "Culture", "Adventure"],
                        bio: "British musician discovering Southeast Asia üé∏ Looking for jam sessions and cultural experiences.",
                        isOnline: true,
                        distance: "1.8 km",
                        matchPercentage: 85,
                        category: "nomads"
                    }
                ],
                restaurants: [
                    {
                        id: 'banh-mi-queen',
                        name: "Banh Mi Queen",
                        type: "Vietnamese Street Food",
                        image: "https://images.unsplash.com/photo-1559339352-11d035aa65de?w=400&h=300&fit=crop",
                        logo: "https://images.unsplash.com/photo-1559339352-11d035aa65de?w=100&h=100&fit=crop",
                        story: "https://images.unsplash.com/photo-1551218808-94e220e084d2?w=150&h=200&fit=crop",
                        promo: "2-for-1 Banh Mi Special",
                        details: "Daily 7am-10pm ‚Ä¢ Perfect for breakfast",
                        description: "Authentic Vietnamese banh mi served fresh daily. A favorite among backpackers for quick, delicious, and affordable meals in the heart of Hoi An Ancient Town.",
                        location: "123 Tran Phu Street, Hoi An",
                        hours: "7:00 AM - 10:00 PM",
                        price: "$ - Budget Friendly",
                        contact: "+84 235 123 456"
                    },
                    {
                        id: 'thuan-tinh-island-bar',
                        name: "Thuan Tinh Island Bar",
                        type: "Riverside Bar & Grill",
                        image: "https://images.unsplash.com/photo-1514933651103-005eec06c04b?w=400&h=300&fit=crop",
                        logo: "https://images.unsplash.com/photo-1514933651103-005eec06c04b?w=100&h=100&fit=crop",
                        story: "https://images.unsplash.com/photo-1514933651103-005eec06c04b?w=150&h=200&fit=crop",
                        promo: "Happy Hour - 50% Off All Drinks",
                        details: "Daily 4pm-2am ‚Ä¢ River views & live music",
                        description: "Stunning riverside location with panoramic views of Thu Bon River. Popular with expats and travelers for sunset drinks, live music, and BBQ nights.",
                        location: "Thuan Tinh Island, Hoi An",
                        hours: "4:00 PM - 2:00 AM",
                        price: "$ - Moderate",
                        contact: "+84 235 234 567"
                    },
                    {
                        id: 'streets-restaurant',
                        name: "Streets Restaurant & Cafe",
                        type: "International Cuisine",
                        image: "https://images.unsplash.com/photo-1470337458703-46ad1756a187?w=400&h=300&fit=crop",
                        logo: "https://images.unsplash.com/photo-1470337458703-46ad1756a187?w=100&h=100&fit=crop",
                        story: "https://images.unsplash.com/photo-1544148103-0773bf10d330?w=150&h=200&fit=crop",
                        promo: "Western Breakfast Special",
                        details: "Daily 7am-11pm ‚Ä¢ WiFi & AC",
                        description: "Western and Vietnamese fusion cuisine in a comfortable, air-conditioned setting. Great for digital nomads with reliable WiFi and international menu options.",
                        location: "45 Le Loi Street, Hoi An",
                        hours: "7:00 AM - 11:00 PM",
                        price: "$ - Moderate",
                        contact: "+84 235 345 678"
                    }
                ],
                activities: [
                    {
                        id: 'basket-boat-tours',
                        name: "Basket Boat Adventure",
                        type: "Water Sports",
                        image: "https://images.unsplash.com/photo-1559339352-11d035aa65de?w=400&h=300&fit=crop",
                        logo: "https://images.unsplash.com/photo-1559339352-11d035aa65de?w=100&h=100&fit=crop",
                        story: "https://images.unsplash.com/photo-1559339352-11d035aa65de?w=150&h=200&fit=crop",
                        promo: "Group Discount - 4+ People Save 30%",
                        details: "Daily tours 8am & 2pm ‚Ä¢ 3 hours duration",
                        description: "Traditional Vietnamese basket boat tours through coconut forests. Perfect group activity for backpackers wanting to experience local culture and nature.",
                        location: "Coconut Forest, Cam Thanh",
                        hours: "8:00 AM - 5:00 PM",
                        price: "$ - Budget Friendly",
                        contact: "+84 235 678 901"
                    }
                ],
                chats: [
                    {
                        name: "Jessica",
                        message: "Perfect! Want to check it out together? üòä",
                        time: "2m",
                        avatar: "https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=100&h=100&fit=crop"
                    },
                    {
                        name: "Dave", 
                        message: "Great surfing spots near Da Nang!",
                        time: "1h",
                        avatar: "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=100&h=100&fit=crop"
                    },
                    {
                        name: "Rebecca",
                        message: "The art scene here is amazing!",
                        time: "3h", 
                        avatar: "https://images.unsplash.com/photo-1508214751196-bcfd4ca60f91?w=100&h=100&fit=crop"
                    }
                ]
            },
            
            // Initialize App
            init() {
                console.log('üöÄ Starting CLASSIFIED v7.0...');
                
                // Setup authentication listener
                this.setupAuthListener();
                
                // Setup event listeners
                this.setupEventListeners();
                
                // Populate static content
                this.populateFeeds();
                this.setupProfileEditor();
                
                // Initialize growth features
                this.initGrowthFeatures();
                
                console.log('‚úÖ CLASSIFIED app ready!');
            },
            
            // üî• Enhanced Firebase Authentication Methods
            setupAuthListener() {
                console.log('üîê Setting up auth listener...');
                if (!window.auth) {
                    console.error('‚ùå Firebase auth not initialized!');
                    return;
                }
                
                window.auth.onAuthStateChanged((user) => {
                    console.log('üîê Auth state changed:', user ? user.email : 'No user');
                    
                    if (user) {
                        this.state.currentUser = user;
                        this.state.isAuthenticated = true;
                        this.state.isGuestMode = false;
                        this.hideAuthScreens();
                        this.loadUserProfile(user.uid);
                        this.populateUserFeed();
                        this.populateMessaging();
                        this.checkIfBusiness(user);
                    } else {
                        this.state.currentUser = null;
                        this.state.isAuthenticated = false;
                        if (!this.state.isGuestMode) {
                            this.showLogin();
                        }
                    }
                });
            },
            
            async checkIfBusiness(user) {
                try {
                    const businessDoc = await window.db.collection('businesses').doc(user.uid).get();
                    if (businessDoc.exists) {
                        this.state.isBusinessUser = true;
                        this.state.businessProfile = businessDoc.data();
                        
                        // Show business-specific UI elements
                        this.showBusinessUI();
                        
                        // Auto-open business profile editor if profile is incomplete
                        if (this.state.businessProfile.status === 'pending_approval' && !this.state.businessProfile.description) {
                            setTimeout(() => {
                                alert('üëã Welcome to CLASSIFIED! Please complete your business profile to get approved faster.');
                                this.openBusinessProfileEditor();
                            }, 2000);
                        }
                        
                        this.loadBusinessProfile(user.uid);
                    }
                } catch (error) {
                    console.error('Error checking business status:', error);
                }
            },
            
            showBusinessUI() {
                // Update header to show business status
                const headers = document.querySelectorAll('.header-title');
                headers.forEach(header => {
                    if (header.textContent.includes('Feeling Adventurous')) {
                        const status = this.state.businessProfile.status;
                        const statusText = status === 'active' ? '‚úÖ Active' : 
                                         status === 'pending_approval' ? '‚è≥ Pending' : '‚ùå Inactive';
                        header.innerHTML = `${header.textContent} <span style="font-size: 12px; opacity: 0.7;">${statusText}</span>`;
                    }
                });
                
                // Add business dashboard button to settings
                this.addBusinessDashboardAccess();
            },
            
            addBusinessDashboardAccess() {
                // This will be used in the settings menu
                console.log('‚úÖ Business UI elements added');
            },
            
            async loginWithEmail() {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                if (!email || !password) {
                    alert('Please enter email and password');
                    return;
                }
                
                try {
                    this.showLoading();
                    await window.auth.signInWithEmailAndPassword(email, password);
                    console.log('‚úÖ Email login successful');
                } catch (error) {
                    this.hideLoading();
                    console.error('‚ùå Login error:', error);
                    alert('Login failed: ' + error.message);
                }
            },
            
            async registerWithEmail() {
                const name = document.getElementById('registerName').value;
                const email = document.getElementById('registerEmail').value;
                const password = document.getElementById('registerPassword').value;
                const confirmPassword = document.getElementById('registerConfirmPassword').value;
                const referralCode = sessionStorage.getItem('referralCode');
                
                console.log('üìù Registration attempt for:', email);
                
                if (!name || !email || !password || !confirmPassword) {
                    alert('Please fill in all fields');
                    return;
                }
                
                if (password !== confirmPassword) {
                    alert('Passwords do not match');
                    return;
                }
                
                if (password.length < 6) {
                    alert('Password must be at least 6 characters');
                    return;
                }
                
                if (!window.auth || !window.db) {
                    alert('Firebase is still loading. Please wait a few seconds and try again.');
                    return;
                }
                
                try {
                    this.showLoading();
                    
                    const userCredential = await window.auth.createUserWithEmailAndPassword(email, password);
                    console.log('‚úÖ User account created:', userCredential.user.uid);
                    
                    // Update display name
                    await userCredential.user.updateProfile({
                        displayName: name
                    });
                    
                    // Generate referral code
                    const newReferralCode = this.generateReferralCode();
                    
                    // Create user profile
                    const profileData = {
                        name: name,
                        email: email,
                        referralCode: newReferralCode,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        location: 'Hoi An, Vietnam',
                        isOnline: true,
                        isPremium: referralCode ? true : false,
                        premiumUntil: referralCode ? new Date(Date.now() + 7 * 24 * 60 * 60 * 1000) : null
                    };
                    
                    await this.createUserProfile(userCredential.user.uid, profileData);
                    
                    // Handle referral
                    if (referralCode) {
                        await this.trackReferral(referralCode, userCredential.user.uid);
                        alert('üéâ Welcome! You and your friend both got premium features!');
                    }
                    
                    // Clear referral code
                    sessionStorage.removeItem('referralCode');
                    
                    console.log('üéâ Registration completed successfully!');
                    
                } catch (error) {
                    this.hideLoading();
                    console.error('‚ùå Registration failed:', error);
                    alert('Registration failed: ' + error.message);
                }
            },
            
            async loginWithGoogle() {
                console.log('üîç Attempting Google login...');
                
                if (!window.auth) {
                    alert('Authentication system not ready. Please refresh and try again.');
                    return;
                }
                
                try {
                    this.showLoading();
                    const provider = new firebase.auth.GoogleAuthProvider();
                    
                    const result = await window.auth.signInWithPopup(provider);
                    
                    // Check if this is a new user
                    const userDoc = await window.db.collection('users').doc(result.user.uid).get();
                    
                    if (!userDoc.exists) {
                        // Create profile for new Google user
                        await this.createUserProfile(result.user.uid, {
                            name: result.user.displayName,
                            email: result.user.email,
                            photo: result.user.photoURL,
                            referralCode: this.generateReferralCode(),
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            location: 'Hoi An, Vietnam',
                            isOnline: true
                        });
                    }
                    
                    console.log('‚úÖ Google login successful');
                } catch (error) {
                    this.hideLoading();
                    console.error('‚ùå Google login error:', error);
                    
                    if (error.code === 'auth/popup-closed-by-user') {
                        console.log('User closed Google popup');
                    } else {
                        alert('Google login failed: ' + error.message);
                    }
                }
            },
            
            async logout() {
                try {
                    await window.auth.signOut();
                    this.state.isGuestMode = false;
                    console.log('‚úÖ Logout successful');
                } catch (error) {
                    console.error('‚ùå Logout error:', error);
                }
            },
            
            // üè¢ Business Authentication Methods
            async businessLogin() {
                const email = document.getElementById('businessLoginEmail').value;
                const password = document.getElementById('businessLoginPassword').value;
                
                if (!email || !password) {
                    alert('Please enter email and password');
                    return;
                }
                
                try {
                    this.showLoading();
                    await window.auth.signInWithEmailAndPassword(email, password);
                    console.log('‚úÖ Business login successful');
                } catch (error) {
                    this.hideLoading();
                    console.error('‚ùå Business login error:', error);
                    alert('Login failed: ' + error.message);
                }
            },
            
            async businessSignup() {
                const name = document.getElementById('businessSignupName').value;
                const email = document.getElementById('businessSignupEmail').value;
                const phone = document.getElementById('businessSignupPhone').value;
                const type = document.getElementById('businessSignupType').value;
                
                if (!name || !email || !phone || !type) {
                    alert('Please fill in all fields');
                    return;
                }
                
                try {
                    this.showLoading();
                    
                    // Create business account directly
                    const tempPassword = this.generateTempPassword();
                    const userCredential = await window.auth.createUserWithEmailAndPassword(email, tempPassword);
                    
                    // Update display name
                    await userCredential.user.updateProfile({
                        displayName: name
                    });
                    
                    // Create business profile
                    await window.db.collection('businesses').doc(userCredential.user.uid).set({
                        name: name,
                        email: email,
                        phone: phone,
                        type: type,
                        status: 'pending_approval',
                        uid: userCredential.user.uid,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        tempPassword: tempPassword,
                        location: 'Hoi An, Vietnam'
                    });
                    
                    this.hideLoading();
                    
                    // Show success with login info
                    alert(`üéâ Business account created! Your temporary password is: ${tempPassword}\n\nYour account is pending approval. You can login now and complete your profile. We'll review it within 24 hours.`);
                    
                    // Switch to login tab
                    this.switchBusinessAuthTab('login');
                    
                    // Pre-fill login form
                    document.getElementById('businessLoginEmail').value = email;
                    document.getElementById('businessLoginPassword').value = tempPassword;
                    
                    console.log('‚úÖ Business account created successfully');
                    
                } catch (error) {
                    this.hideLoading();
                    console.error('‚ùå Business signup error:', error);
                    alert('Signup failed: ' + error.message);
                }
            },
            
            generateTempPassword() {
                return Math.random().toString(36).slice(-8);
            },
            
            switchBusinessAuthTab(tab) {
                // Update tab buttons
                document.querySelectorAll('.business-auth-tab').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[onclick="CLASSIFIED.switchBusinessAuthTab('${tab}')"]`).classList.add('active');
                
                // Update form visibility
                document.querySelectorAll('.business-auth-form').forEach(form => {
                    form.classList.remove('active');
                });
                document.getElementById(`business${tab.charAt(0).toUpperCase() + tab.slice(1)}Form`).classList.add('active');
            },
            
            // üë§ Guest Mode Implementation
            enableGuestMode() {
                console.log('üë§ Enabling guest mode');
                this.state.isGuestMode = true;
                this.state.isAuthenticated = false;
                
                // Hide auth screens
                this.hideAuthScreens();
                
                // Show guest banner
                document.getElementById('guestBanner').style.display = 'block';
                
                // Populate feeds with demo data
                this.populateFeeds();
                this.populateGuestUserFeed();
                
                // Show restricted features message
                setTimeout(() => {
                    this.showGuestLimitationsMessage();
                }, 3000);
            },
            
            populateGuestUserFeed() {
                const container = document.getElementById('userFeedContainer');
                container.innerHTML = '';
                
                // Show first 3 users to guests
                const guestUsers = this.data.users.slice(0, 3);
                guestUsers.forEach((user, index) => {
                    const feedItem = this.createUserFeedItem(user, index);
                    
                    // Add guest overlay to limit interactions
                    const overlay = document.createElement('div');
                    overlay.innerHTML = `
                        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; border-radius: 20px; z-index: 10;">
                            <div style="text-align: center; padding: 20px;">
                                <h3 style="color: #FFD700; margin-bottom: 10px;">üîí Sign up to connect!</h3>
                                <button onclick="CLASSIFIED.showRegister()" style="background: linear-gradient(135deg, #00D4FF, #0099CC); border: none; padding: 10px 20px; border-radius: 20px; color: white; font-weight: 600; cursor: pointer;">
                                    Create Account
                                </button>
                            </div>
                        </div>
                    `;
                    overlay.style.position = 'relative';
                    feedItem.appendChild(overlay);
                    
                    container.appendChild(feedItem);
                });
                
                // Add signup encouragement
                const signupCard = document.createElement('div');
                signupCard.innerHTML = `
                    <div style="background: linear-gradient(135deg, #FFD700, #FF6B6B); padding: 30px; border-radius: 20px; text-align: center; margin: 20px 0;">
                        <h3 style="margin: 0 0 15px 0; font-size: 20px;">üöÄ Ready to connect?</h3>
                        <p style="margin: 0 0 20px 0; opacity: 0.9;">Join ${this.data.users.length}+ travelers already using CLASSIFIED</p>
                        <button onclick="CLASSIFIED.showRegister()" style="background: rgba(255,255,255,0.2); border: none; padding: 12px 24px; border-radius: 25px; color: white; font-weight: 600; cursor: pointer; margin-right: 10px;">
                            Sign Up Free
                        </button>
                        <button onclick="CLASSIFIED.showLogin()" style="background: transparent; border: 2px solid rgba(255,255,255,0.3); padding: 10px 22px; border-radius: 25px; color: white; font-weight: 600; cursor: pointer;">
                            Login
                        </button>
                    </div>
                `;
                container.appendChild(signupCard);
            },
            
            showGuestLimitationsMessage() {
                const message = document.createElement('div');
                message.innerHTML = `
                    <div style="position: fixed; top: 20px; right: 20px; background: rgba(255,215,0,0.9); color: white; padding: 15px 20px; border-radius: 15px; font-size: 14px; font-weight: 600; z-index: 999; max-width: 300px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                        <div style="margin-bottom: 10px;">üëã Browsing as guest</div>
                        <div style="font-size: 12px; opacity: 0.9;">Sign up to message people, upload photos, and access all features!</div>
                        <button onclick="this.parentElement.remove(); CLASSIFIED.showRegister();" style="background: rgba(255,255,255,0.2); border: none; padding: 6px 12px; border-radius: 10px; color: white; font-size: 11px; font-weight: 600; cursor: pointer; margin-top: 10px;">
                            Sign Up Now
                        </button>
                    </div>
                `;
                document.body.appendChild(message);
                
                setTimeout(() => {
                    message.remove();
                }, 8000);
            },
            
            // üî• Enhanced Firestore Methods
            async createUserProfile(uid, profileData) {
                try {
                    await window.db.collection('users').doc(uid).set(profileData);
                    console.log('‚úÖ User profile created in Firestore');
                } catch (error) {
                    console.error('‚ùå Error creating user profile:', error);
                    throw error;
                }
            },
            
            async loadUserProfile(uid) {
                try {
                    const doc = await window.db.collection('users').doc(uid).get();
                    if (doc.exists) {
                        const userData = doc.data();
                        this.state.userProfile = { ...this.state.userProfile, ...userData };
                        console.log('‚úÖ User profile loaded:', userData);
                    }
                } catch (error) {
                    console.error('‚ùå Error loading user profile:', error);
                }
            },
            
            async saveUserProfile() {
                if (!this.state.currentUser) {
                    alert('Please log in first');
                    return;
                }
                
                try {
                    // Gather form data
                    this.state.userProfile.bio = document.getElementById('profileBio').value;
                    this.state.userProfile.birthday = document.getElementById('profileBirthday').value;
                    this.state.userProfile.height = document.getElementById('profileHeight').value;
                    this.state.userProfile.name = this.state.currentUser.displayName || this.state.userProfile.name;
                    this.state.userProfile.email = this.state.currentUser.email;
                    
                    // Calculate age from birthday
                    if (this.state.userProfile.birthday) {
                        const today = new Date();
                        const birthDate = new Date(this.state.userProfile.birthday);
                        let age = today.getFullYear() - birthDate.getFullYear();
                        const monthDiff = today.getMonth() - birthDate.getMonth();
                        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                            age--;
                        }
                        this.state.userProfile.age = age;
                    }
                    
                    // Add required fields for user feed
                    this.state.userProfile.uid = this.state.currentUser.uid;
                    this.state.userProfile.isOnline = true;
                    this.state.userProfile.lastSeen = firebase.firestore.FieldValue.serverTimestamp();
                    this.state.userProfile.location = 'Hoi An, Vietnam';
                    this.state.userProfile.matchPercentage = Math.floor(Math.random() * 30) + 70;
                    this.state.userProfile.distance = `${Math.floor(Math.random() * 5) + 1} km`;
                    this.state.userProfile.category = this.state.userProfile.career === 'Digital Nomad' ? 'nomads' : 'all';
                    
                    // Generate referral code if not exists
                    if (!this.state.userProfile.referralCode) {
                        this.state.userProfile.referralCode = this.generateReferralCode();
                    }
                    
                    // Save to Firebase
                    await window.db.collection('users').doc(this.state.currentUser.uid).set({
                        ...this.state.userProfile,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    
                    console.log('üíæ Profile saved successfully:', this.state.userProfile);
                    alert('Profile saved successfully! üéâ You\'ll now appear in the user feed.');
                    
                    // Refresh user feed
                    this.closeProfileEditor();
                    this.populateUserFeed();
                    
                    // Show success with referral code
                    setTimeout(() => {
                        this.showReferralCode();
                    }, 1000);
                    
                } catch (error) {
                    console.error('‚ùå Error saving profile:', error);
                    alert('Error saving profile: ' + error.message);
                }
            },
            
            async loadBusinessProfile(uid) {
                try {
                    const doc = await window.db.collection('businesses').doc(uid).get();
                    if (doc.exists) {
                        const businessData = doc.data();
                        this.state.businessProfile = { ...this.state.businessProfile, ...businessData };
                        console.log('‚úÖ Business profile loaded:', businessData);
                    }
                } catch (error) {
                    console.error('‚ùå Error loading business profile:', error);
                }
            },
            
            async saveBusinessProfile() {
                if (!this.state.currentUser) {
                    alert('Please log in first');
                    return;
                }
                
                try {
                    // Gather form data
                    this.state.businessProfile.name = document.getElementById('businessName').value;
                    this.state.businessProfile.type = document.getElementById('businessType').value;
                    this.state.businessProfile.description = document.getElementById('businessDescription').value;
                    this.state.businessProfile.address = document.getElementById('businessAddress').value;
                    this.state.businessProfile.phone = document.getElementById('businessPhone').value;
                    this.state.businessProfile.hours = document.getElementById('businessHours').value;
                    this.state.businessProfile.priceRange = document.getElementById('businessPriceRange').value;
                    this.state.businessProfile.promoTitle = document.getElementById('businessPromoTitle').value;
                    this.state.businessProfile.promoDetails = document.getElementById('businessPromoDetails').value;
                    
                    // Add required fields
                    this.state.businessProfile.uid = this.state.currentUser.uid;
                    this.state.businessProfile.email = this.state.currentUser.email;
                    this.state.businessProfile.status = 'active';
                    
                    // Save to Firebase
                    await window.db.collection('businesses').doc(this.state.currentUser.uid).set({
                        ...this.state.businessProfile,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    
                    console.log('üíæ Business profile saved successfully');
                    alert('Business profile saved successfully! üéâ Your business will appear in the feeds.');
                    
                    // Refresh feeds
                    this.closeBusinessProfileEditor();
                    this.populateFeeds();
                    
                } catch (error) {
                    console.error('‚ùå Error saving business profile:', error);
                    alert('Error saving business profile: ' + error.message);
                }
            },
            
            // üì∏ Enhanced Photo Upload System
            triggerPhotoUpload(slotIndex) {
                console.log('üì∏ Triggering photo upload for slot:', slotIndex);
                this.state.currentUploadSlot = slotIndex;
                document.getElementById('photoUpload').click();
            },
            
            async handlePhotoUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const slotIndex = this.state.currentUploadSlot;
                console.log('üì∏ Handling photo upload:', file.name, 'to slot', slotIndex);
                
                if (!this.state.currentUser) {
                    alert('Please log in to upload photos');
                    return;
                }
                
                try {
                    // Show upload progress
                    const slot = document.querySelectorAll('.photo-slot')[slotIndex];
                    slot.classList.add('uploading');
                    slot.innerHTML = `
                        <div style="text-align: center;">
                            <div>üì§</div>
                            <div style="font-size: 12px; margin-top: 5px;">Uploading...</div>
                            <div class="upload-progress">
                                <div class="upload-progress-bar" style="width: 0%"></div>
                            </div>
                        </div>
                    `;
                    
                    // Upload to Firebase Storage
                    const storageRef = window.storage.ref();
                    const photoRef = storageRef.child(`users/${this.state.currentUser.uid}/photo_${slotIndex}_${Date.now()}`);
                    
                    const uploadTask = photoRef.put(file);
                    
                    uploadTask.on('state_changed', 
                        (snapshot) => {
                            // Progress tracking
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            const progressBar = slot.querySelector('.upload-progress-bar');
                            if (progressBar) {
                                progressBar.style.width = progress + '%';
                            }
                        },
                        (error) => {
                            console.error('‚ùå Upload failed:', error);
                            slot.classList.remove('uploading');
                            slot.innerHTML = `<span style="font-size: 24px; opacity: 0.5;">+</span>`;
                            alert('Upload failed: ' + error.message);
                        },
                        async () => {
                            // Upload completed successfully
                            try {
                                const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                                
                                // Update UI
                                slot.classList.remove('uploading');
                                slot.classList.add('filled');
                                slot.style.backgroundImage = `url('${downloadURL}')`;
                                slot.innerHTML = slotIndex === 0 ? '<div class="star-icon">‚≠ê</div>' : '';
                                
                                // Save to state
                                this.state.userProfile.photos[slotIndex] = downloadURL;
                                
                                console.log('‚úÖ Photo uploaded successfully');
                                
                                // Auto-save profile
                                await this.saveUserProfile();
                                
                            } catch (error) {
                                console.error('‚ùå Error getting download URL:', error);
                                alert('Error saving photo: ' + error.message);
                            }
                        }
                    );
                    
                } catch (error) {
                    console.error('‚ùå Error uploading photo:', error);
                    alert('Error uploading photo: ' + error.message);
                }
            },
            
            triggerBusinessPhotoUpload(slotIndex) {
                console.log('üì∏ Triggering business photo upload for slot:', slotIndex);
                this.state.currentBusinessUploadSlot = slotIndex;
                document.getElementById('businessPhotoUpload').click();
            },
            
            async handleBusinessPhotoUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const slotIndex = this.state.currentBusinessUploadSlot;
                console.log('üì∏ Handling business photo upload:', file.name, 'to slot', slotIndex);
                
                if (!this.state.currentUser) {
                    alert('Please log in to upload photos');
                    return;
                }
                
                try {
                    // Show upload progress
                    const slot = document.querySelectorAll('#businessPhotoGrid .photo-slot')[slotIndex];
                    slot.classList.add('uploading');
                    slot.innerHTML = `
                        <div style="text-align: center;">
                            <div>üì§</div>
                            <div style="font-size: 12px; margin-top: 5px;">Uploading...</div>
                            <div class="upload-progress">
                                <div class="upload-progress-bar" style="width: 0%"></div>
                            </div>
                        </div>
                    `;
                    
                    // Upload to Firebase Storage
                    const storageRef = window.storage.ref();
                    const photoRef = storageRef.child(`businesses/${this.state.currentUser.uid}/photo_${slotIndex}_${Date.now()}`);
                    
                    const uploadTask = photoRef.put(file);
                    
                    uploadTask.on('state_changed', 
                        (snapshot) => {
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            const progressBar = slot.querySelector('.upload-progress-bar');
                            if (progressBar) {
                                progressBar.style.width = progress + '%';
                            }
                        },
                        (error) => {
                            console.error('‚ùå Business upload failed:', error);
                            slot.classList.remove('uploading');
                            slot.innerHTML = `<span style="font-size: 24px; opacity: 0.5;">+</span>`;
                            alert('Upload failed: ' + error.message);
                        },
                        async () => {
                            try {
                                const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                                
                                // Update UI
                                slot.classList.remove('uploading');
                                slot.classList.add('filled');
                                slot.style.backgroundImage = `url('${downloadURL}')`;
                                slot.innerHTML = slotIndex === 0 ? '<div class="star-icon">‚≠ê</div>' : '';
                                
                                // Save to state
                                this.state.businessProfile.photos[slotIndex] = downloadURL;
                                
                                console.log('‚úÖ Business photo uploaded successfully');
                                
                                // Auto-save business profile
                                await this.saveBusinessProfile();
                                
                            } catch (error) {
                                console.error('‚ùå Error getting business download URL:', error);
                                alert('Error saving business photo: ' + error.message);
                            }
                        }
                    );
                    
                } catch (error) {
                    console.error('‚ùå Error uploading business photo:', error);
                    alert('Error uploading business photo: ' + error.message);
                }
            },
            
            // üîÑ Referral System
            generateReferralCode() {
                return Math.random().toString(36).substring(2, 8).toUpperCase();
            },
            
            async trackReferral(referralCode, newUserId) {
                try {
                    const referrerSnapshot = await window.db.collection('users')
                        .where('referralCode', '==', referralCode)
                        .get();
                        
                    if (!referrerSnapshot.empty) {
                        const referrerId = referrerSnapshot.docs[0].id;
                        
                        // Save referral record
                        await window.db.collection('referrals').add({
                            referrer: referrerId,
                            referred: newUserId,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            bonus: 'premium_week',
                            status: 'active'
                        });
                        
                        // Update referrer's stats
                        await window.db.collection('users').doc(referrerId).update({
                            referralCount: firebase.firestore.FieldValue.increment(1),
                            premiumUntil: firebase.firestore.FieldValue.serverTimestamp() + (7 * 24 * 60 * 60 * 1000)
                        });
                        
                        console.log('‚úÖ Referral tracked successfully');
                    }
                } catch (error) {
                    console.error('‚ùå Error tracking referral:', error);
                }
            },
            
            shareApp() {
                const referralCode = this.state.userProfile.referralCode || this.generateReferralCode();
                const shareUrl = `${window.location.origin}?ref=${referralCode}`;
                
                const shareData = {
                    title: 'CLASSIFIED - Hoi An Social Discovery',
                    text: `Join me on CLASSIFIED - discover hidden gems and meet amazing people in Hoi An! üåü Use my code: ${referralCode}`,
                    url: shareUrl
                };
                
                if (navigator.share) {
                    navigator.share(shareData);
                } else {
                    navigator.clipboard.writeText(`${shareData.text}\n\n${shareData.url}`);
                    alert('‚úÖ Referral link copied to clipboard! Share it with your friends üì±');
                }
            },
            
            showReferralCode() {
                const referralCode = this.state.userProfile.referralCode || this.generateReferralCode();
                const shareUrl = `${window.location.origin}?ref=${referralCode}`;
                
                const modal = document.createElement('div');
                modal.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px;" onclick="this.remove()">
                        <div style="background: #2a2a2a; border-radius: 20px; padding: 30px; max-width: 350px; width: 100%; text-align: center; border: 1px solid rgba(255,255,255,0.1);" onclick="event.stopPropagation()">
                            <h3 style="margin: 0 0 20px 0; color: #00D4FF;">üîë Your Referral Code</h3>
                            
                            <div style="background: rgba(0,212,255,0.1); border: 2px solid #00D4FF; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                                <div style="font-size: 32px; font-weight: 700; color: #00D4FF; margin-bottom: 10px;">${referralCode}</div>
                                <div style="font-size: 14px; opacity: 0.8;">Share this code with friends</div>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <p style="margin: 0 0 10px 0; font-size: 14px; opacity: 0.9;">When friends sign up with your code:</p>
                                <ul style="text-align: left; margin: 0; padding-left: 20px; font-size: 14px; opacity: 0.8;">
                                    <li>You both get 1 week premium</li>
                                    <li>Access to exclusive events</li>
                                    <li>Priority customer support</li>
                                </ul>
                            </div>
                            
                            <div style="display: flex; gap: 10px;">
                                <button onclick="navigator.clipboard.writeText('${referralCode}'); alert('Code copied!')" style="flex: 1; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; cursor: pointer;">
                                    Copy Code
                                </button>
                                <button onclick="navigator.clipboard.writeText('${shareUrl}'); alert('Link copied!')" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #00D4FF, #0099CC); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">
                                    Copy Link
                                </button>
                            </div>
                            
                            <button onclick="this.closest('div').remove()" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; cursor: pointer; margin-top: 10px;">
                                Close
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            },
            
            checkReferralCode() {
                const urlParams = new URLSearchParams(window.location.search);
                const referralCode = urlParams.get('ref');
                
                if (referralCode) {
                    sessionStorage.setItem('referralCode', referralCode);
                    
                    // Show referral welcome message
                    setTimeout(() => {
                        const welcomeModal = document.createElement('div');
                        welcomeModal.innerHTML = `
                            <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px;">
                                <div style="background: #2a2a2a; border-radius: 20px; padding: 30px; max-width: 350px; width: 100%; text-align: center; border: 1px solid rgba(255,215,0,0.3);" onclick="event.stopPropagation()">
                                    <h3 style="margin: 0 0 20px 0; color: #FFD700;">üéâ Welcome to CLASSIFIED!</h3>
                                    <p style="margin: 0 0 20px 0; font-size: 16px;">You've been invited by a friend!</p>
                                    <div style="background: rgba(255,215,0,0.1); border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                                        <p style="margin: 0; font-size: 14px; opacity: 0.9;">Sign up with code <strong>${referralCode}</strong> and you'll both get premium features!</p>
                                    </div>
                                    <button onclick="this.closest('div').remove(); CLASSIFIED.showRegister();" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #FFD700, #FF6B6B); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">
                                        Sign Up Now üöÄ
                                    </button>
                                </div>
                            </div>
                        `;
                        document.body.appendChild(welcomeModal);
                    }, 1000);
                }
            },
            
            // üì± UI Helper Methods
            showLogin() {
                document.getElementById('loginScreen').classList.add('show');
                document.getElementById('registerScreen').classList.remove('show');
                document.getElementById('businessAuthScreen').classList.remove('show');
                document.querySelector('.main-screens').classList.remove('authenticated');
                document.querySelector('.bottom-nav').style.display = 'none';
                document.getElementById('guestBanner').style.display = 'none';
            },
            
            showRegister() {
                document.getElementById('registerScreen').classList.add('show');
                document.getElementById('loginScreen').classList.remove('show');
                document.getElementById('businessAuthScreen').classList.remove('show');
            },
            
            showBusinessAuth() {
                document.getElementById('businessAuthScreen').classList.add('show');
                document.getElementById('loginScreen').classList.remove('show');
                document.getElementById('registerScreen').classList.remove('show');
            },
            
            hideAuthScreens() {
                document.getElementById('loginScreen').classList.remove('show');
                document.getElementById('registerScreen').classList.remove('show');
                document.getElementById('businessAuthScreen').classList.remove('show');
                document.querySelector('.main-screens').classList.add('authenticated');
                document.querySelector('.bottom-nav').style.display = 'flex';
                document.getElementById('guestBanner').style.display = 'none';
                this.hideLoading();
            },
            
            showLoading() {
                document.getElementById('loadingOverlay').classList.add('show');
            },
            
            hideLoading() {
                document.getElementById('loadingOverlay').classList.remove('show');
            },
            
            // üîß Event Listeners
            setupEventListeners() {
                // Bottom navigation
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        const screen = item.dataset.screen;
                        this.showScreen(screen);
                    });
                });
                
                // Social tabs
                document.querySelectorAll('.social-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        const tabType = tab.dataset.tab;
                        this.switchSocialTab(tabType);
                    });
                });
                
                // Filter chips
                document.querySelectorAll('.filter-chip').forEach(chip => {
                    chip.addEventListener('click', (e) => {
                        const filter = chip.dataset.filter;
                        this.filterUsers(filter);
                    });
                });
                
                // Overlay back buttons
                document.getElementById('profileBackBtn').addEventListener('click', () => this.closeBusinessProfile());
                document.getElementById('chatBackBtn').addEventListener('click', () => this.closeChat());
                
                // Chat functionality
                document.getElementById('sendBtn').addEventListener('click', () => this.sendMessage());
                document.getElementById('messageInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendMessage();
                });
                
                // Match popup
                document.getElementById('startChatBtn').addEventListener('click', () => this.startChatFromMatch());
            },
            
            // üìù Profile Editor Setup
            setupProfileEditor() {
                // Choice buttons
                document.querySelectorAll('.choice-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const choiceType = btn.dataset.choice;
                        const value = btn.dataset.value;
                        this.selectChoice(choiceType, value, btn);
                    });
                });
                
                // Interest buttons
                document.querySelectorAll('.interest-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.toggleInterest(btn);
                    });
                });
            },
            
            // üìù Profile Editor Functions
            openProfileEditor() {
                console.log('‚úèÔ∏è Opening profile editor');
                document.getElementById('profileEditor').classList.add('show');
                this.state.isProfileEditorOpen = true;
                this.loadProfileData();
            },
            
            closeProfileEditor() {
                console.log('üîô Closing profile editor');
                document.getElementById('profileEditor').classList.remove('show');
                this.state.isProfileEditorOpen = false;
            },
            
            openBusinessProfileEditor() {
                console.log('üè¢ Opening business profile editor');
                document.getElementById('businessProfileEditor').classList.add('show');
                this.state.isBusinessProfileEditorOpen = true;
                this.loadBusinessProfileData();
            },
            
            closeBusinessProfileEditor() {
                console.log('üîô Closing business profile editor');
                document.getElementById('businessProfileEditor').classList.remove('show');
                this.state.isBusinessProfileEditorOpen = false;
            },
            
            viewMyProfile() {
                console.log('üë§ Viewing my profile');
                this.closeProfileEditor();
                document.getElementById('myProfileView').classList.add('show');
                this.updateMyProfileView();
            },
            
            closeMyProfile() {
                console.log('üîô Closing my profile');
                document.getElementById('myProfileView').classList.remove('show');
            },
            
            viewBusinessProfile() {
                console.log('üè¢ Viewing business profile');
                this.closeBusinessProfileEditor();
                // Could open business profile view here
            },
            
            loadProfileData() {
                const profile = this.state.userProfile;
                
                // Load basic info
                document.getElementById('profileBio').value = profile.bio || '';
                document.getElementById('profileBirthday').value = profile.birthday || '';
                document.getElementById('profileHeight').value = profile.height || '';
                
                // Load choices
                if (profile.zodiac) this.selectChoiceByValue('zodiac', profile.zodiac);
                if (profile.career) this.selectChoiceByValue('career', profile.career);
                if (profile.priority) this.selectChoiceByValue('priority', profile.priority);
                if (profile.relationship) this.selectChoiceByValue('relationship', profile.relationship);
                if (profile.lookingFor) this.selectChoiceByValue('lookingFor', profile.lookingFor);
                if (profile.marriage) this.selectChoiceByValue('marriage', profile.marriage);
                
                // Load interests
                document.querySelectorAll('.interest-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (profile.interests.includes(btn.dataset.interest)) {
                        btn.classList.add('active');
                    }
                });
                
                // Load photos
                if (profile.photos && profile.photos.length > 0) {
                    profile.photos.forEach((photo, index) => {
                        if (photo) {
                            const slot = document.querySelectorAll('.photo-slot')[index];
                            if (slot) {
                                slot.style.backgroundImage = `url('${photo}')`;
                                slot.classList.add('filled');
                                slot.innerHTML = index === 0 ? '<div class="star-icon">‚≠ê</div>' : '';
                            }
                        }
                    });
                }
            },
            
            loadBusinessProfileData() {
                const profile = this.state.businessProfile;
                
                // Load basic info
                document.getElementById('businessName').value = profile.name || '';
                document.getElementById('businessType').value = profile.type || '';
                document.getElementById('businessDescription').value = profile.description || '';
                document.getElementById('businessAddress').value = profile.address || '';
                document.getElementById('businessPhone').value = profile.phone || '';
                document.getElementById('businessHours').value = profile.hours || '';
                document.getElementById('businessPriceRange').value = profile.priceRange || '';
                document.getElementById('businessPromoTitle').value = profile.promoTitle || '';
                document.getElementById('businessPromoDetails').value = profile.promoDetails || '';
                
                // Load photos
                if (profile.photos && profile.photos.length > 0) {
                    profile.photos.forEach((photo, index) => {
                        if (photo) {
                            const slot = document.querySelectorAll('#businessPhotoGrid .photo-slot')[index];
                            if (slot) {
                                slot.style.backgroundImage = `url('${photo}')`;
                                slot.classList.add('filled');
                                slot.innerHTML = index === 0 ? '<div class="star-icon">‚≠ê</div>' : '';
                            }
                        }
                    });
                }
            },
            
            selectChoice(choiceType, value, buttonElement) {
                // Remove active from siblings
                const siblings = buttonElement.parentElement.querySelectorAll('.choice-btn');
                siblings.forEach(btn => btn.classList.remove('active'));
                
                // Add active to clicked button
                buttonElement.classList.add('active');
                
                // Update state
                this.state.userProfile[choiceType] = value;
                console.log(`Selected ${choiceType}: ${value}`);
            },
            
            selectChoiceByValue(choiceType, value) {
                const btn = document.querySelector(`[data-choice="${choiceType}"][data-value="${value}"]`);
                if (btn) {
                    this.selectChoice(choiceType, value, btn);
                }
            },
            
            toggleInterest(buttonElement) {
                const interest = buttonElement.dataset.interest;
                const isActive = buttonElement.classList.contains('active');
                
                if (isActive) {
                    buttonElement.classList.remove('active');
                    this.state.userProfile.interests = this.state.userProfile.interests.filter(i => i !== interest);
                } else {
                    if (this.state.userProfile.interests.length < 8) {
                        buttonElement.classList.add('active');
                        this.state.userProfile.interests.push(interest);
                    } else {
                        alert('You can select up to 8 interests!');
                    }
                }
                console.log('Current interests:', this.state.userProfile.interests);
            },
            
            updateMyProfileView() {
                const profile = this.state.userProfile;
                
                // Update profile view with user data
                document.getElementById('myProfileName').textContent = profile.name || 'Your Name';
                document.getElementById('myProfileAge').textContent = profile.age ? `${profile.age} years old` : 'Add your age';
                document.getElementById('myProfileBio').textContent = profile.bio || 'Complete your profile to start connecting with amazing people in Hoi An!';
                
                // Update details
                document.getElementById('myProfileAgeDetail').textContent = profile.age || '-';
                document.getElementById('myProfileHeightDetail').textContent = profile.height || '-';
                document.getElementById('myProfileCareerDetail').textContent = profile.career || '-';
                document.getElementById('myProfileZodiacDetail').textContent = profile.zodiac || '-';
                document.getElementById('myProfileLookingForDetail').textContent = profile.lookingFor || '-';
                
                // Update interests
                const interestsContainer = document.getElementById('myProfileInterests');
                if (profile.interests && profile.interests.length > 0) {
                    interestsContainer.innerHTML = profile.interests.map(interest => 
                        `<span class="interest-tag">${interest}</span>`
                    ).join('');
                } else {
                    interestsContainer.innerHTML = '<span class="interest-tag">Add interests in profile editor</span>';
                }
                
                // Update hero image if photos available
                if (profile.photos && profile.photos.length > 0) {
                    document.getElementById('myProfileHero').style.backgroundImage = `url('${profile.photos[0]}')`;
                }
            },
            
            shareMyProfile() {
                const shareText = `Check out my profile on CLASSIFIED Hoi An! üåü`;
                if (navigator.share) {
                    navigator.share({
                        title: 'My CLASSIFIED Profile',
                        text: shareText,
                        url: window.location.href
                    });
                } else {
                    navigator.clipboard.writeText(shareText + ' - ' + window.location.href);
                    alert('Profile link copied to clipboard! üìã');
                }
            },
            
            // ‚öôÔ∏è Settings & Account Management
            openSettings() {
                const settingsMenu = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 500; display: flex; align-items: center; justify-content: center;" onclick="this.remove()">
                        <div style="background: #2a2a2a; border-radius: 20px; padding: 30px; max-width: 300px; width: 90%; border: 1px solid rgba(255,255,255,0.1); max-height: 80vh; overflow-y: auto;" onclick="event.stopPropagation()">
                            <h3 style="margin: 0 0 20px 0; text-align: center; color: #00D4FF;">Settings</h3>
                            ${this.state.isAuthenticated ? `
                                <button onclick="CLASSIFIED.openProfileEditor(); this.closest('.settings-overlay').remove();" style="width: 100%; padding: 12px; margin-bottom: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: white; cursor: pointer;">‚úèÔ∏è Edit Profile</button>
                                <button onclick="CLASSIFIED.viewMyProfile(); this.closest('.settings-overlay').remove();" style="width: 100%; padding: 12px; margin-bottom: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: white; cursor: pointer;">üë§ View My Profile</button>
                                ${this.state.isBusinessUser ? `
                                    <button onclick="CLASSIFIED.openBusinessProfileEditor(); this.closest('.settings-overlay').remove();" style="width: 100%; padding: 12px; margin-bottom: 10px; background: rgba(255,215,0,0.1); border: 1px solid rgba(255,215,0,0.3); border-radius: 10px; color: #FFD700; cursor: pointer;">üè¢ Business Profile</button>
                                    <button onclick="CLASSIFIED.viewBusinessDashboard(); this.closest('.settings-overlay').remove();" style="width: 100%; padding: 12px; margin-bottom: 10px; background: rgba(255,215,0,0.1); border: 1px solid rgba(255,215,0,0.3); border-radius: 10px; color: #FFD700; cursor: pointer;">üìä Business Dashboard</button>
                                ` : ''}
                                <button onclick="CLASSIFIED.showReferralCode(); this.closest('.settings-overlay').remove();" style="width: 100%; padding: 12px; margin-bottom: 10px; background: rgba(0,212,255,0.1); border: 1px solid rgba(0,212,255,0.3); border-radius: 10px; color: #00D4FF; cursor: pointer;">üîë Referral Code</button>
                                ${this.isAdminUser() ? `
                                    <button onclick="CLASSIFIED.openAdminPanel(); this.closest('.settings-overlay').remove();" style="width: 100%; padding: 12px; margin-bottom: 10px; background: rgba(255,107,107,0.1); border: 1px solid rgba(255,107,107,0.3); border-radius: 10px; color: #FF6B6B; cursor: pointer;">üõ°Ô∏è Admin Panel</button>
                                ` : ''}
                                <button onclick="CLASSIFIED.logout(); this.closest('.settings-overlay').remove();" style="width: 100%; padding: 12px; background: rgba(255,107,107,0.2); border: 1px solid rgba(255,107,107,0.3); border-radius: 10px; color: #FF6B6B; cursor: pointer;">üö™ Logout</button>
                            ` : `
                                <button onclick="CLASSIFIED.showLogin(); this.closest('.settings-overlay').remove();" style="width: 100%; padding: 12px; margin-bottom: 10px; background: linear-gradient(135deg, #00D4FF, #0099CC); border: none; border-radius: 10px; color: white; cursor: pointer;">üîê Login</button>
                                <button onclick="CLASSIFIED.showRegister(); this.closest('.settings-overlay').remove();" style="width: 100%; padding: 12px; margin-bottom: 10px; background: linear-gradient(135deg, #FFD700, #FF6B6B); border: none; border-radius: 10px; color: white; cursor: pointer;">üöÄ Sign Up</button>
                                <button onclick="CLASSIFIED.showBusinessAuth(); this.closest('.settings-overlay').remove();" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: white; cursor: pointer;">üè¢ Business Login</button>
                            `}
                        </div>
                    </div>
                `;
                
                const overlay = document.createElement('div');
                overlay.className = 'settings-overlay';
                overlay.innerHTML = settingsMenu;
                document.body.appendChild(overlay);
            },
            
            isAdminUser() {
                // Check if current user is admin (replace with your actual admin email)
                return this.state.currentUser && (
                    this.state.currentUser.email === 'admin@classified.com' || 
                    this.state.currentUser.email === 'your-admin-email@gmail.com' // Replace with your email
                );
            },
            
            viewBusinessDashboard() {
                if (!this.state.isBusinessUser) {
                    alert('Access denied: Business account required');
                    return;
                }
                
                const dashboard = document.createElement('div');
                dashboard.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px;" onclick="this.remove()">
                        <div style="background: #2a2a2a; border-radius: 20px; padding: 30px; max-width: 400px; width: 100%; border: 1px solid rgba(255,255,255,0.1); max-height: 80vh; overflow-y: auto;" onclick="event.stopPropagation()">
                            <h3 style="margin: 0 0 20px 0; text-align: center; color: #FFD700;">üè¢ Business Dashboard</h3>
                            
                            <div style="background: rgba(255,215,0,0.1); border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                                <h4 style="margin: 0 0 10px 0; color: #FFD700;">Account Status</h4>
                                <p style="margin: 0; font-size: 14px;">Status: <strong>${this.state.businessProfile.status}</strong></p>
                                <p style="margin: 5px 0 0 0; font-size: 12px; opacity: 0.8;">
                                    ${this.state.businessProfile.status === 'active' ? 'Your business is live on CLASSIFIED!' : 
                                      this.state.businessProfile.status === 'pending_approval' ? 'Your profile is being reviewed. Complete it to speed up approval.' : 
                                      'Please complete your profile to get approved.'}
                                </p>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <h4 style="margin: 0 0 10px 0; color: #00D4FF;">Quick Actions</h4>
                                <button onclick="CLASSIFIED.openBusinessProfileEditor(); this.closest('div').remove();" style="width: 100%; padding: 10px; margin-bottom: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; cursor: pointer;">‚úèÔ∏è Edit Profile</button>
                                <button onclick="CLASSIFIED.viewBusinessAnalytics(); this.closest('div').remove();" style="width: 100%; padding: 10px; margin-bottom: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; cursor: pointer;">üìä View Analytics</button>
                                <button onclick="CLASSIFIED.managePromotions(); this.closest('div').remove();" style="width: 100%; padding: 10px; margin-bottom: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; cursor: pointer;">üéØ Manage Promotions</button>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <h4 style="margin: 0 0 10px 0; color: #00D4FF;">Help & Support</h4>
                                <p style="margin: 0; font-size: 12px; opacity: 0.8;">Need help? Contact us at support@classified.com</p>
                            </div>
                            
                            <button onclick="this.closest('div').remove()" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; cursor: pointer;">
                                Close
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(dashboard);
            },
            
            viewBusinessAnalytics() {
                alert('üìä Analytics feature coming soon! You\'ll be able to see views, clicks, and customer engagement here.');
            },
            
            managePromotions() {
                alert('üéØ Promotions management coming soon! You\'ll be able to create and manage special offers here.');
            },
            
            openAdminPanel() {
                if (!this.isAdminUser()) {
                    alert('Access denied: Admin privileges required');
                    return;
                }
                
                this.loadPendingBusinesses();
            },
            
            async loadPendingBusinesses() {
                try {
                    const snapshot = await window.db.collection('businesses')
                        .where('status', '==', 'pending_approval')
                        .orderBy('createdAt', 'desc')
                        .get();
                    
                    const businesses = [];
                    snapshot.forEach(doc => {
                        businesses.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    this.showAdminPanel(businesses);
                    
                } catch (error) {
                    console.error('Error loading pending businesses:', error);
                    alert('Error loading pending businesses');
                }
            },
            
            showAdminPanel(businesses) {
                const panel = document.createElement('div');
                panel.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px;" onclick="this.remove()">
                        <div style="background: #2a2a2a; border-radius: 20px; padding: 30px; max-width: 500px; width: 100%; border: 1px solid rgba(255,255,255,0.1); max-height: 80vh; overflow-y: auto;" onclick="event.stopPropagation()">
                            <h3 style="margin: 0 0 20px 0; text-align: center; color: #FF6B6B;">üõ°Ô∏è Admin Panel</h3>
                            
                            <h4 style="margin: 0 0 15px 0; color: #00D4FF;">Pending Business Approvals (${businesses.length})</h4>
                            
                            ${businesses.length === 0 ? `
                                <p style="text-align: center; opacity: 0.7; margin: 40px 0;">No pending approvals</p>
                            ` : businesses.map(business => `
                                <div style="background: rgba(255,255,255,0.05); border-radius: 10px; padding: 15px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1);">
                                    <h4 style="margin: 0 0 8px 0; color: #FFD700;">${business.name}</h4>
                                    <p style="margin: 0 0 5px 0; font-size: 12px; opacity: 0.8;">Type: ${business.type}</p>
                                    <p style="margin: 0 0 5px 0; font-size: 12px; opacity: 0.8;">Email: ${business.email}</p>
                                    <p style="margin: 0 0 5px 0; font-size: 12px; opacity: 0.8;">Phone: ${business.phone}</p>
                                    <p style="margin: 0 0 10px 0; font-size: 12px; opacity: 0.8;">Created: ${business.createdAt?.toDate().toLocaleDateString()}</p>
                                    
                                    <div style="display: flex; gap: 8px; margin-top: 10px;">
                                        <button onclick="CLASSIFIED.approveBusiness('${business.id}'); this.closest('.admin-panel').remove();" style="flex: 1; padding: 8px; background: rgba(76,175,80,0.2); border: 1px solid rgba(76,175,80,0.3); border-radius: 6px; color: #4CAF50; cursor: pointer; font-size: 12px;">
                                            ‚úÖ Approve
                                        </button>
                                        <button onclick="CLASSIFIED.rejectBusiness('${business.id}'); this.closest('.admin-panel').remove();" style="flex: 1; padding: 8px; background: rgba(255,107,107,0.2); border: 1px solid rgba(255,107,107,0.3); border-radius: 6px; color: #FF6B6B; cursor: pointer; font-size: 12px;">
                                            ‚ùå Reject
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                            
                            <button onclick="this.closest('div').remove()" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; cursor: pointer; margin-top: 15px;">
                                Close
                            </button>
                        </div>
                    </div>
                `;
                
                panel.className = 'admin-panel';
                document.body.appendChild(panel);
            },
            
            async approveBusiness(businessId) {
                try {
                    await window.db.collection('businesses').doc(businessId).update({
                        status: 'active',
                        approvedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    alert('‚úÖ Business approved successfully!');
                    
                    // Refresh feeds to show new business
                    this.populateFeeds();
                    
                } catch (error) {
                    console.error('Error approving business:', error);
                    alert('Error approving business');
                }
            },
            
            async rejectBusiness(businessId) {
                if (!confirm('Are you sure you want to reject this business?')) return;
                
                try {
                    await window.db.collection('businesses').doc(businessId).update({
                        status: 'rejected',
                        rejectedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    alert('‚ùå Business rejected');
                    
                } catch (error) {
                    console.error('Error rejecting business:', error);
                    alert('Error rejecting business');
                }
            },
            
            // üì± Screen Management
            showScreen(screenType) {
                console.log(`üì± Switching to ${screenType} screen`);
                
                // Check if guest trying to access restricted features
                if (this.state.isGuestMode && screenType === 'social') {
                    alert('üîí Sign up to access social features and connect with other travelers!');
                    this.showRegister();
                    return;
                }
                
                this.state.currentScreen = screenType;
                
                // Hide all screens
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.remove('active');
                });
                
                // Show target screen
                document.getElementById(`${screenType}Screen`).classList.add('active');
                
                // Update navigation
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelector(`[data-screen="${screenType}"]`).classList.add('active');
                
                // Reset social tab when leaving social screen
                if (screenType !== 'social') {
                    this.switchSocialTab('userFeed');
                }
            },
            
            switchSocialTab(tabType) {
                console.log(`üîÑ Switching to ${tabType} tab`);
                this.state.currentSocialTab = tabType;
                
                // Update tabs
                document.querySelectorAll('.social-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`[data-tab="${tabType}"]`).classList.add('active');
                
                // Update content
                document.querySelectorAll('.social-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tabType}Content`).classList.add('active');
            },
            
            // üçΩÔ∏è Feed Management
            populateFeeds() {
                this.populateRestaurantFeed();
                this.populateActivityFeed();
            },
            
            async populateRestaurantFeed() {
                const storiesContainer = document.getElementById('restaurantStories');
                const feedContainer = document.getElementById('restaurantFeed');
                
                try {
                    // Show loading
                    feedContainer.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
                    
                    // Try to fetch from Firebase first
                    if (this.state.isAuthenticated) {
                        const snapshot = await window.db.collection('businesses')
                            .where('type', '==', 'restaurant')
                            .where('status', '==', 'active')
                            .orderBy('updatedAt', 'desc')
                            .limit(20)
                            .get();
                        
                        const restaurants = [];
                        snapshot.forEach(doc => {
                            const business = doc.data();
                            restaurants.push({
                                id: doc.id,
                                name: business.name,
                                type: business.type,
                                image: business.photos?.[0] || 'https://images.unsplash.com/photo-1559339352-11d035aa65de?w=400&h=300&fit=crop',
                                logo: business.photos?.[1] || business.photos?.[0] || 'https://images.unsplash.com/photo-1559339352-11d035aa65de?w=100&h=100&fit=crop',
                                story: business.photos?.[0] || 'https://images.unsplash.com/photo-1551218808-94e220e084d2?w=150&h=200&fit=crop',
                                promo: business.promoTitle || 'Special Offer',
                                details: business.promoDetails || 'Ask about our current promotions',
                                description: business.description || 'Great food and atmosphere in Hoi An',
                                location: business.address || 'Hoi An Ancient Town',
                                hours: business.hours || 'Daily 8am-10pm',
                                price: business.priceRange === 'budget' ? '$ - Budget Friendly' : 
                                       business.priceRange === 'expensive' ? '$$ - Expensive' : '$ - Moderate',
                                contact: business.phone || '+84 123 456 789'
                            });
                        });
                        
                        // If Firebase has restaurants, use them
                        if (restaurants.length > 0) {
                            this.renderRestaurantFeed(restaurants, storiesContainer, feedContainer);
                            return;
                        }
                    }
                    
                    // Fallback to demo data
                    this.renderRestaurantFeed(this.data.restaurants, storiesContainer, feedContainer);
                    
                } catch (error) {
                    console.error('‚ùå Error loading restaurants:', error);
                    // Fallback to demo data
                    this.renderRestaurantFeed(this.data.restaurants, storiesContainer, feedContainer);
                }
            },
            
            renderRestaurantFeed(restaurants, storiesContainer, feedContainer) {
                // Populate stories
                storiesContainer.innerHTML = restaurants.slice(0, 10).map(restaurant => 
                    `<div class="story-item" style="background-image: url('${restaurant.story}')">
                        <div class="story-overlay">
                            <div class="story-title">${restaurant.name}</div>
                            <div class="story-subtitle">${restaurant.type}</div>
                        </div>
                    </div>`
                ).join('');
                
                // Populate feed
                feedContainer.innerHTML = restaurants.map(restaurant => 
                    this.createBusinessCard(restaurant, 'restaurant')
                ).join('');
                
                // Add business signup banner
                this.addBusinessSignupBanner(feedContainer);
                
                // Add admin notice if there are pending businesses
                if (this.isAdminUser()) {
                    this.addAdminNotice(feedContainer);
                }
                
                console.log('üçΩÔ∏è Restaurant feed populated with', restaurants.length, 'businesses');
            },
            
            async addAdminNotice(container) {
                try {
                    const pendingSnapshot = await window.db.collection('businesses')
                        .where('status', '==', 'pending_approval')
                        .get();
                    
                    if (pendingSnapshot.size > 0) {
                        const adminNotice = document.createElement('div');
                        adminNotice.innerHTML = `
                            <div style="background: rgba(255,107,107,0.1); border: 1px solid rgba(255,107,107,0.3); border-radius: 15px; padding: 20px; margin: 20px 0; text-align: center;">
                                <h3 style="margin: 0 0 10px 0; color: #FF6B6B;">üõ°Ô∏è Admin Notice</h3>
                                <p style="margin: 0 0 15px 0; font-size: 14px;">${pendingSnapshot.size} business${pendingSnapshot.size > 1 ? 'es' : ''} pending approval</p>
                                <button onclick="CLASSIFIED.openAdminPanel()" style="background: rgba(255,107,107,0.2); border: 1px solid rgba(255,107,107,0.3); border-radius: 20px; padding: 8px 16px; color: #FF6B6B; cursor: pointer; font-size: 12px;">
                                    Review Applications
                                </button>
                            </div>
                        `;
                        container.appendChild(adminNotice);
                    }
                } catch (error) {
                    console.error('Error checking pending businesses:', error);
                }
            },
            
            async populateActivityFeed() {
                const storiesContainer = document.getElementById('activityStories');
                const feedContainer = document.getElementById('activityFeed');
                
                try {
                    feedContainer.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
                    
                    // Try to fetch from Firebase first
                    if (this.state.isAuthenticated) {
                        const snapshot = await window.db.collection('businesses')
                            .where('type', '==', 'activity')
                            .where('status', '==', 'active')
                            .orderBy('updatedAt', 'desc')
                            .limit(20)
                            .get();
                        
                        const activities = [];
                        snapshot.forEach(doc => {
                            const business = doc.data();
                            activities.push({
                                id: doc.id,
                                name: business.name,
                                type: business.type,
                                image: business.photos?.[0] || 'https://images.unsplash.com/photo-1559339352-11d035aa65de?w=400&h=300&fit=crop',
                                logo: business.photos?.[1] || business.photos?.[0] || 'https://images.unsplash.com/photo-1559339352-11d035aa65de?w=100&h=100&fit=crop',
                                story: business.photos?.[0] || 'https://images.unsplash.com/photo-1559339352-11d035aa65de?w=150&h=200&fit=crop',
                                promo: business.promoTitle || 'Special Activity',
                                details: business.promoDetails || 'Book now for special rates',
                                description: business.description || 'Amazing activity experience in Hoi An',
                                location: business.address || 'Hoi An, Vietnam',
                                hours: business.hours || 'Daily tours available',
                                price: business.priceRange === 'budget' ? '$ - Budget Friendly' : 
                                       business.priceRange === 'expensive' ? '$$ - Expensive' : '$ - Moderate',
                                contact: business.phone || '+84 123 456 789'
                            });
                        });
                        
                        if (activities.length > 0) {
                            this.renderActivityFeed(activities, storiesContainer, feedContainer);
                            return;
                        }
                    }
                    
                    // Fallback to demo data
                    this.renderActivityFeed(this.data.activities, storiesContainer, feedContainer);
                    
                } catch (error) {
                    console.error('‚ùå Error loading activities:', error);
                    this.renderActivityFeed(this.data.activities, storiesContainer, feedContainer);
                }
            },
            
            renderActivityFeed(activities, storiesContainer, feedContainer) {
                // Populate stories
                storiesContainer.innerHTML = activities.slice(0, 10).map(activity => 
                    `<div class="story-item" style="background-image: url('${activity.story}')">
                        <div class="story-overlay">
                            <div class="story-title">${activity.name}</div>
                            <div class="story-subtitle">${activity.type}</div>
                        </div>
                    </div>`
                ).join('');
                
                // Populate feed
                feedContainer.innerHTML = activities.map(activity => 
                    this.createBusinessCard(activity, 'activity')
                ).join('');
                
                // Add business signup banner
                this.addBusinessSignupBanner(feedContainer);
                
                console.log('üéØ Activity feed populated with', activities.length, 'businesses');
            },
            
            createBusinessCard(business, type) {
                return `
                    <div class="business-card" onclick="CLASSIFIED.openBusinessProfile('${business.id}', '${type}')">
                        <div class="business-header">
                            <div class="business-logo" style="background-image: url('${business.logo}')"></div>
                            <div class="business-info">
                                <h3>${business.name}</h3>
                                <p>${business.type}</p>
                            </div>
                        </div>
                        <div class="business-image" style="background-image: url('${business.image}')"></div>
                        <div class="business-content">
                            <div class="business-description">${business.description.substring(0, 100)}...</div>
                            <div class="business-promo">
                                <div class="promo-title">${business.promo}</div>
                                <div class="promo-details">${business.details}</div>
                            </div>
                        </div>
                    </div>
                `;
            },
            
            addBusinessSignupBanner(container) {
                const banner = document.createElement('div');
                banner.className = 'business-signup-banner';
                banner.innerHTML = `
                    <h3>üè™ Own a Business in Hoi An?</h3>
                    <p>Create your account instantly and reach 100+ travelers daily</p>
                    <div class="cta-button" onclick="CLASSIFIED.showBusinessSignup()">
                        Create Business Account üöÄ
                    </div>
                `;
                
                // Insert after the 3rd business card
                const businessCards = container.querySelectorAll('.business-card');
                if (businessCards.length >= 3) {
                    businessCards[2].insertAdjacentElement('afterend', banner);
                } else {
                    container.appendChild(banner);
                }
            },
            
            showBusinessSignup() {
                const modal = document.createElement('div');
                modal.className = 'business-signup-modal';
                modal.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px;" onclick="this.remove()">
                        <div style="background: #2a2a2a; border-radius: 20px; padding: 30px; max-width: 400px; width: 100%; border: 1px solid rgba(255,255,255,0.1);" onclick="event.stopPropagation()">
                            <h3 style="margin: 0 0 20px 0; text-align: center; color: #FFD700;">üè™ Partner with CLASSIFIED</h3>
                            
                            <div style="background: rgba(0,212,255,0.1); border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                                <h4 style="margin: 0 0 10px 0; color: #00D4FF;">What You Get:</h4>
                                <ul style="margin: 0; padding-left: 20px; opacity: 0.9;">
                                    <li>‚úÖ Instant account creation</li>
                                    <li>‚úÖ Direct access to 100+ travelers</li>
                                    <li>‚úÖ Featured placement in app</li>
                                    <li>‚úÖ Custom promotion tools</li>
                                    <li>‚úÖ Real-time customer insights</li>
                                </ul>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <input type="text" placeholder="Business Name" id="quickBusinessName" style="width: 100%; padding: 12px; margin-bottom: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                                <input type="email" placeholder="Email Address" id="quickBusinessEmail" style="width: 100%; padding: 12px; margin-bottom: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                                <input type="tel" placeholder="WhatsApp Number" id="quickBusinessPhone" style="width: 100%; padding: 12px; margin-bottom: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                                <select id="quickBusinessType" style="width: 100%; padding: 12px; margin-bottom: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                                    <option value="">Select Business Type</option>
                                    <option value="restaurant">Restaurant/Bar</option>
                                    <option value="activity">Activity/Tour</option>
                                    <option value="accommodation">Hotel/Hostel</option>
                                    <option value="retail">Shop/Retail</option>
                                </select>
                            </div>
                            
                            <div style="display: flex; gap: 10px;">
                                <button onclick="this.closest('.business-signup-modal').remove()" style="flex: 1; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; cursor: pointer;">
                                    Cancel
                                </button>
                                <button onclick="CLASSIFIED.submitQuickBusinessSignup()" style="flex: 2; padding: 12px; background: linear-gradient(135deg, #FFD700, #FF6B6B); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">
                                    Create Account üöÄ
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            },
            
            async submitQuickBusinessSignup() {
                const name = document.getElementById('quickBusinessName').value;
                const email = document.getElementById('quickBusinessEmail').value;
                const phone = document.getElementById('quickBusinessPhone').value;
                const type = document.getElementById('quickBusinessType').value;
                
                if (!name || !email || !phone || !type) {
                    alert('Please fill in all fields');
                    return;
                }
                
                try {
                    // Create business account directly
                    const tempPassword = this.generateTempPassword();
                    const userCredential = await window.auth.createUserWithEmailAndPassword(email, tempPassword);
                    
                    // Update display name
                    await userCredential.user.updateProfile({
                        displayName: name
                    });
                    
                    // Create business profile
                    await window.db.collection('businesses').doc(userCredential.user.uid).set({
                        name: name,
                        email: email,
                        phone: phone,
                        type: type,
                        status: 'pending_approval',
                        uid: userCredential.user.uid,
                        source: 'quick_signup',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        tempPassword: tempPassword,
                        location: 'Hoi An, Vietnam'
                    });
                    
                    // Close modal and show success
                    document.querySelector('.business-signup-modal').remove();
                    
                    // Show success message with login info
                    setTimeout(() => {
                        alert(`üéâ Business account created!\n\nEmail: ${email}\nPassword: ${tempPassword}\n\nYou can now login and complete your profile. We'll review it within 24 hours.`);
                        
                        // Optionally redirect to business login
                        this.showBusinessAuth();
                        document.getElementById('businessLoginEmail').value = email;
                        document.getElementById('businessLoginPassword').value = tempPassword;
                    }, 300);
                    
                    console.log('‚úÖ Quick business signup completed');
                    
                } catch (error) {
                    console.error('‚ùå Error submitting business signup:', error);
                    alert('Error creating account: ' + error.message);
                }
            },
            
            // üë• User Feed Management
            async populateUserFeed() {
                if (!this.state.isAuthenticated) return;
                
                const container = document.getElementById('userFeedContainer');
                container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
                
                try {
                    // Fetch real users from Firebase
                    const snapshot = await window.db.collection('users')
                        .where('uid', '!=', this.state.currentUser.uid)
                        .orderBy('updatedAt', 'desc')
                        .limit(20)
                        .get();
                    
                    const users = [];
                    snapshot.forEach(doc => {
                        const userData = doc.data();
                        // Only include users with complete profiles
                        if (userData.name && userData.bio && userData.interests && userData.interests.length > 0) {
                            users.push({
                                id: doc.id,
                                uid: userData.uid,
                                name: userData.name,
                                age: userData.age || 25,
                                image: userData.photos?.[0] || userData.photo || 'https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=400&h=600&fit=crop',
                                interests: userData.interests || ['Travel', 'Adventure'],
                                bio: userData.bio || 'Exploring Hoi An!',
                                isOnline: userData.isOnline || false,
                                distance: userData.distance || `${Math.floor(Math.random() * 5) + 1} km`,
                                matchPercentage: userData.matchPercentage || Math.floor(Math.random() * 30) + 70,
                                category: userData.category || 'all',
                                career: userData.career,
                                lookingFor: userData.lookingFor
                            });
                        }
                    });
                    
                    // Show user count
                    const userCount = users.length;
                    console.log(`üë• Found ${userCount} users in feed`);
                    
                    // If we have real users, display them
                    if (users.length > 0) {
                        container.innerHTML = '';
                        users.forEach((user, index) => {
                            const feedItem = this.createUserFeedItem(user, index);
                            container.appendChild(feedItem);
                        });
                        
                        // Add activity indicator
                        const activityIndicator = document.createElement('div');
                        activityIndicator.innerHTML = `
                            <div style="text-align: center; padding: 20px; background: rgba(0,212,255,0.1); margin: 20px 0; border-radius: 15px;">
                                <h3>üî• ${userCount} travelers active in Hoi An</h3>
                                <p>Join the community and start connecting!</p>
                            </div>
                        `;
                        container.appendChild(activityIndicator);
                        
                    } else {
                        // Show encouraging message for first users
                        container.innerHTML = `
                            <div style="text-align: center; padding: 40px; opacity: 0.9;">
                                <div style="font-size: 48px; margin-bottom: 20px;">üöÄ</div>
                                <div style="font-size: 20px; margin-bottom: 15px; color: #00D4FF;">Be the first!</div>
                                <div style="font-size: 16px; margin-bottom: 10px;">You're among the first travelers to join CLASSIFIED.</div>
                                <div style="font-size: 14px; opacity: 0.7;">Complete your profile and invite friends to start connecting!</div>
                                <button onclick="CLASSIFIED.shareApp()" style="margin-top: 20px; padding: 12px 24px; background: linear-gradient(135deg, #00D4FF, #0099CC); border: none; border-radius: 25px; color: white; font-weight: 600; cursor: pointer;">
                                    Share CLASSIFIED üöÄ
                                </button>
                            </div>
                        `;
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error loading users:', error);
                    // Show error message
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; opacity: 0.7;">
                            <div style="font-size: 48px; margin-bottom: 20px;">‚ö†Ô∏è</div>
                            <div style="font-size: 18px; margin-bottom: 10px;">Unable to load users</div>
                            <div style="font-size: 14px;">Please check your internet connection and try again.</div>
                            <button onclick="CLASSIFIED.populateUserFeed()" style="margin-top: 20px; padding: 12px 24px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 25px; color: white; cursor: pointer;">
                                Try Again
                            </button>
                        </div>
                    `;
                }
            },
            
            filterUsers(filter) {
                console.log(`üîç Filtering users by: ${filter}`);
                // Update active filter chip
                document.querySelectorAll('.filter-chip').forEach(chip => {
                    chip.classList.remove('active');
                });
                document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
                
                // Filter users based on criteria
                let filteredUsers = this.data.users;
                if (filter === 'online') {
                    filteredUsers = this.data.users.filter(user => user.isOnline);
                } else if (filter === 'nearby') {
                    filteredUsers = this.data.users.filter(user => {
                        const distance = parseFloat(user.distance);
                        return distance < 2; // Within 2km
                    });
                } else if (filter === 'nomads') {
                    filteredUsers = this.data.users.filter(user => user.category === 'nomads');
                }
                
                // Re-populate feed with filtered users
                const container = document.getElementById('userFeedContainer');
                container.innerHTML = '';
                filteredUsers.forEach((user, index) => {
                    const feedItem = this.createUserFeedItem(user, index);
                    container.appendChild(feedItem);
                });
            },
            
            createUserFeedItem(user, index) {
                const feedItem = document.createElement('div');
                feedItem.className = 'user-feed-item';
                feedItem.style.animationDelay = `${index * 0.1}s`;
                feedItem.style.cursor = 'pointer';
                
                // Make the entire card clickable to view profile
                feedItem.addEventListener('click', (e) => {
                    // Don't open profile if clicking on action buttons
                    if (!e.target.closest('.user-actions')) {
                        this.openUserProfile(user);
                    }
                });
                
                feedItem.innerHTML = `
                    <div class="user-status-badges">
                        ${user.isOnline ? '<div class="status-badge status-online">üü¢ Online</div>' : ''}
                        <div class="status-badge status-distance">üìç ${user.distance}</div>
                        <div class="status-badge status-match">üî• ${user.matchPercentage}% Match</div>
                    </div>
                    <div class="user-image" style="background-image: url('${user.image}')">
                        <div class="user-image-overlay">
                            <div class="user-name">${user.name}, ${user.age}</div>
                        </div>
                    </div>
                    <div class="user-info">
                        <div class="user-bio">${user.bio}</div>
                        <div class="user-interests">
                            ${user.interests.map(interest => `<span class="interest-tag">${interest}</span>`).join('')}
                        </div>
                        <div class="user-actions">
                            <button class="action-btn pass-btn" onclick="event.stopPropagation(); CLASSIFIED.handleUserAction('pass', '${user.name}')">‚úï Pass</button>
                            <button class="action-btn chat-btn" onclick="event.stopPropagation(); CLASSIFIED.handleUserAction('like', '${user.name}')">üí¨ Chat</button>
                            <button class="action-btn super-btn" onclick="event.stopPropagation(); CLASSIFIED.handleUserAction('superlike', '${user.name}')">‚≠ê Super</button>
                        </div>
                    </div>
                `;
                return feedItem;
            },
            
            // üë§ User Profile Management
            openUserProfile(user) {
                console.log(`üë§ Opening ${user.name}'s profile`);
                document.getElementById('userProfileView').classList.add('show');
                this.state.isUserProfileOpen = true;
                this.state.currentViewedUser = user;
                
                // Populate user profile data
                document.getElementById('userProfileTitle').textContent = user.name;
                document.getElementById('userProfileHero').style.backgroundImage = `url('${user.image}')`;
                document.getElementById('userProfileName').textContent = user.name;
                document.getElementById('userProfileAge').textContent = `${user.age} years old`;
                document.getElementById('userProfileMatch').textContent = `${user.matchPercentage}% Match`;
                document.getElementById('userProfileBio').textContent = user.bio;
                document.getElementById('userProfileDistance').textContent = user.distance;
                document.getElementById('userProfileStatus').textContent = user.isOnline ? 'Online Now' : 'Offline';
                document.getElementById('userProfileCategory').textContent = user.category === 'nomads' ? 'Digital Nomad' : 'Traveler';
                
                // Update interests
                const interestsContainer = document.getElementById('userProfileInterests');
                interestsContainer.innerHTML = user.interests.map(interest => 
                    `<span class="interest-tag">${interest}</span>`
                ).join('');
            },
            
            closeUserProfile() {
                console.log('üîô Closing user profile');
                document.getElementById('userProfileView').classList.remove('show');
                this.state.isUserProfileOpen = false;
                this.state.currentViewedUser = null;
            },
            
            startChatWithViewedUser() {
                if (this.state.currentViewedUser) {
                    const user = this.state.currentViewedUser;
                    this.closeUserProfile();
                    setTimeout(() => {
                        this.openChatWithUser(user.name);
                    }, 300);
                }
            },
            
            openProfileFromChat() {
                console.log('üîç Opening profile from chat');
                console.log('Current chat user state:', this.state.currentChatUser);
                
                let user = null;
                
                if (this.state.currentChatUser) {
                    user = this.state.currentChatUser;
                    console.log('‚úÖ Found user from currentChatUser:', user.name);
                } else {
                    const chatNameElement = document.getElementById('chatName');
                    const chatName = chatNameElement ? chatNameElement.textContent.trim() : '';
                    console.log('üîÑ Looking up user by chat name:', chatName);
                    
                    if (chatName) {
                        user = this.data.users.find(u => u.name.trim() === chatName);
                        if (user) {
                            console.log('‚úÖ Found user by name lookup:', user.name);
                            this.state.currentChatUser = user;
                        }
                    }
                }
                
                if (user) {
                    console.log('üöÄ Opening user profile for:', user.name);
                    this.openUserProfile(user);
                } else {
                    console.error('‚ùå Could not find user data');
                    alert('Could not load user profile. Please try again.');
                }
            },
            
            handleUserAction(action, userName) {
                console.log(`üëÜ ${action} action for ${userName}`);
                
                if (!userName && this.state.currentViewedUser) {
                    userName = this.state.currentViewedUser.name;
                }
                
                if (action === 'like' || action === 'superlike') {
                    if (this.state.isUserProfileOpen) {
                        this.closeUserProfile();
                    }
                    
                    if (userName === 'Jessica') {
                        setTimeout(() => this.showMatchPopup(), 500);
                    } else {
                        setTimeout(() => {
                            alert(`You liked ${userName}! üíï They'll be notified when they're online.`);
                        }, 300);
                    }
                } else if (action === 'pass') {
                    if (this.state.isUserProfileOpen) {
                        this.closeUserProfile();
                    }
                    setTimeout(() => {
                        console.log(`Passed on ${userName}`);
                    }, 300);
                }
            },
            
            showMatchPopup() {
                document.getElementById('matchPopup').classList.add('show');
            },
            
            startChatFromMatch() {
                document.getElementById('matchPopup').classList.remove('show');
                this.openChatWithUser('Jessica');
            },
            
            // üí¨ Messaging System
            populateMessaging() {
                const matchesContainer = document.getElementById('matchesScroll');
                const chatListContainer = document.getElementById('chatList');
                
                // Matches
                matchesContainer.innerHTML = this.data.users.slice(0, 3).map(user => 
                    `<div class="match-avatar" style="background-image: url('${user.image}')" 
                         onclick="CLASSIFIED.openChatWithUser('${user.name}')"></div>`
                ).join('');
                
                // Chat list
                chatListContainer.innerHTML = this.data.chats.map(chat => 
                    `<div class="chat-item" onclick="CLASSIFIED.openChatWithUser('${chat.name}')">
                        <div class="chat-avatar" style="background-image: url('${chat.avatar}')"></div>
                        <div class="chat-info">
                            <div class="chat-name">${chat.name}</div>
                            <div class="chat-message">${chat.message}</div>
                        </div>
                        <div class="chat-time">${chat.time}</div>
                    </div>`
                ).join('');
                
                console.log('üí¨ Messaging populated');
            },
            
            openChatWithUser(userName) {
                console.log(`üí¨ Opening chat with user: ${userName}`);
                
                const user = this.data.users.find(u => u.name === userName);
                
                if (user) {
                    console.log('‚úÖ Found user object:', user);
                    this.state.currentChatUser = user;
                    this.openChat(user.name, user.image);
                } else {
                    console.error('‚ùå Could not find user:', userName);
                    this.openChat(userName, '');
                }
            },
            
            openChat(name, avatar) {
                console.log(`üí¨ Opening chat with ${name}`);
                const chat = document.getElementById('individualChat');
                chat.classList.add('show');
                this.state.isChatOpen = true;
                
                const user = this.data.users.find(u => u.name === name);
                this.state.currentChatUser = user;
                
                document.getElementById('chatName').textContent = name;
                document.getElementById('chatAvatar').style.backgroundImage = `url('${avatar}')`;
            },
            
            closeChat() {
                console.log('üîô Closing chat');
                document.getElementById('individualChat').classList.remove('show');
                this.state.isChatOpen = false;
                this.state.currentChatUser = null;
            },
            
            sendMessage() {
                const input = document.getElementById('messageInput');
                const messages = document.getElementById('chatMessages');
                if (input.value.trim()) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'message sent';
                    messageDiv.innerHTML = `<div class="message-bubble">${input.value}</div>`;
                    messages.appendChild(messageDiv);
                    messages.scrollTop = messages.scrollHeight;
                    input.value = '';
                    console.log('üì® Message sent');
                }
            },
            
            // üè¢ Business Profile Management
            openBusinessProfile(businessId, type) {
                console.log(`üè™ Opening ${businessId} profile`);
                const businesses = type === 'restaurant' ? this.data.restaurants : this.data.activities;
                const business = businesses.find(b => b.id === businessId);
                if (!business) {
                    console.error('Business not found:', businessId);
                    return;
                }
                
                const profile = document.getElementById('businessProfile');
                profile.classList.add('show');
                this.state.isProfileOpen = true;
                this.state.currentBusiness = { business, type };
                
                // Populate profile data
                document.getElementById('profileHeaderTitle').textContent = business.name;
                document.getElementById('profileHero').style.backgroundImage = `url('${business.image}')`;
                document.getElementById('profileName').textContent = business.name;
                document.getElementById('profileType').textContent = business.type;
                document.getElementById('profilePromoTitle').textContent = business.promo;
                document.getElementById('profilePromoDetails').textContent = business.details;
                document.getElementById('profileDescription').textContent = business.description;
                document.getElementById('profileLocation').textContent = business.location;
                document.getElementById('profileHours').textContent = business.hours;
                document.getElementById('profilePrice').textContent = business.price;
                document.getElementById('profileContact').textContent = business.contact;
            },
            
            closeBusinessProfile() {
                console.log('üîô Closing business profile');
                document.getElementById('businessProfile').classList.remove('show');
                this.state.isProfileOpen = false;
                this.state.currentBusiness = null;
            },
            
            shareBusinessProfile() {
                if (this.state.currentBusiness) {
                    const business = this.state.currentBusiness.business;
                    const shareText = `Check out ${business.name} in Hoi An! ${business.promo}`;
                    if (navigator.share) {
                        navigator.share({
                            title: business.name,
                            text: shareText,
                            url: window.location.href
                        });
                    } else {
                        navigator.clipboard.writeText(shareText + ' - ' + window.location.href);
                        alert('Business info copied to clipboard! üìã');
                    }
                }
            },
            
            getDirections() {
                if (this.state.currentBusiness) {
                    const business = this.state.currentBusiness.business;
                    const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(business.location)}`;
                    window.open(mapsUrl, '_blank');
                }
            },
            
            // üî• Growth Features
            initGrowthFeatures() {
                this.checkReferralCode();
                
                // Show social proof notifications every 30 seconds
                setInterval(() => {
                    if (this.state.isAuthenticated && Math.random() > 0.5) {
                        this.showSocialProof();
                    }
                }, 30000);
                
                // Show user growth features after 10 seconds
                setTimeout(() => {
                    if (this.state.isAuthenticated) {
                        this.showUserGrowthFeatures();
                    }
                }, 10000);
            },
            
            showSocialProof() {
                const proofs = [
                    'üéâ Sarah just found her adventure buddy!',
                    'üçª Mike discovered 3 new bars this week',
                    'üì∏ Emma shared amazing photos from her food tour',
                    'üéµ Dave found the perfect live music venue',
                    'üåü Jessica made 5 new connections today'
                ];
                
                const randomProof = proofs[Math.floor(Math.random() * proofs.length)];
                
                const notification = document.createElement('div');
                notification.className = 'social-proof-notification';
                notification.textContent = randomProof;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 4000);
            },
            
            showUserGrowthFeatures() {
                const referralBanner = document.createElement('div');
                referralBanner.className = 'referral-banner';
                referralBanner.innerHTML = `
                    <h3>üéâ Invite Friends & Get Premium!</h3>
                    <p>Both you and your friend get 1 week premium features</p>
                    <div class="btn-group">
                        <button onclick="CLASSIFIED.shareApp()">Share App üì±</button>
                        <button onclick="CLASSIFIED.showReferralCode()">My Code üîë</button>
                    </div>
                `;
                
                // Add to restaurant screen after stories
                const restaurantStories = document.getElementById('restaurantStories');
                if (restaurantStories) {
                    restaurantStories.parentElement.insertAdjacentElement('afterend', referralBanner);
                }
            }
        };
        
        // Make CLASSIFIED globally available
        window.CLASSIFIED = CLASSIFIED;
        
        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ DOM loaded, initializing CLASSIFIED...');
            CLASSIFIED.init();
        });
    </script>
</body>
</html>
